{% extends "base.html" %}
{% block title %}Calendar{% endblock %}

{% block content %}
<!-- FullCalendar Stylesheet -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

<style>
  /* Light + Dark mode adjustments for FullCalendar */
  body { transition: background-color 0.3s ease, color 0.3s ease; }
  .container { margin-top: 30px; }
  #calendar { padding: 20px; }

  .fc-day-today { background-color: #e0f7fa !important; }
  .fc-now-indicator-line { border-top: 2px solid #ff5252 !important; }
  .fc-event { border-radius: 4px !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: none !important; }

  .dark-mode .fc .fc-toolbar-title { color: #ffffff !important; }
  .dark-mode .fc .fc-day-header { background-color: #232323 !important; color: #ffffff !important; border-color: #333333 !important; }
  .dark-mode .fc .fc-daygrid-day-frame, .dark-mode .fc .fc-timegrid-col-frame { background-color: #181818 !important; border-color: #333333 !important; color: #ffffff !important; }
  .dark-mode .fc-theme-standard td, .dark-mode .fc-theme-standard th { border-color: #333333 !important; }
  .dark-mode .fc-daygrid-day-number { color: #ffffff !important; }
  .dark-mode .fc-day-today { background-color: #1f1f1f !important; border: 1px solid #66bb6a !important; }
  .dark-mode .fc-now-indicator-line { border-top: 2px solid #ffccd2 !important; }
</style>

<div class="container">
  <h1 class="text-center mb-4" style="font-weight: bold;">Calendar</h1>
  <div id="calendar"></div>
  <div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
  </div>
  
</div>

<!-- FullCalendar Scripts -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>

<script>
  // Role from Flask
  var userRole = "{{ role }}";

  document.addEventListener("DOMContentLoaded", function () {
    var calendarEl = document.getElementById("calendar");
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "timeGridWeek",
      slotMinTime: "08:00:00",
      slotDuration: "00:30:00",
      snapDuration: "00:15:00",
      nowIndicator: true,
      editable: userRole === "admin",
      selectable: userRole === "admin",
      eventDurationEditable: userRole === "admin",
      eventResizableFromStart: userRole === "admin",
      headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,timeGridWeek,timeGridDay" },
      events: function (fetchInfo, successCallback, failureCallback) {
        fetch("/get-events")
          .then((response) => response.json())
          .then((events) => {
            events.forEach((event) => {
              if (event.start.endsWith("T00:00:00") && event.end.endsWith("T00:00:00")) {
                event.allDay = true;
              }
            });
            successCallback(events);
          })
          .catch((error) => failureCallback(error));
      },
      eventClick: function (info) {
        if (userRole !== "admin") return;
        info.jsEvent.preventDefault();
        openEventModal(info.event);
      },
      select: function (info) {
        if (userRole !== "admin") return;
        openEventModal(null, info);
      },
      eventDrop: function (info) { if (userRole === "admin") updateEventDate(info.event); },
      eventResize: function (info) { if (userRole === "admin") updateEventDate(info.event); }
    });

    calendar.render();

    function updateEventDate(event) {
      fetch("/update-event-datetime", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: event.id, start: event.start.toISOString(), end: event.end ? event.end.toISOString() : event.start.toISOString() })
      }).catch((error) => alert("Failed to update event date/time."));
    }

    function openEventModal(event, selectionInfo = null) {
      if (document.getElementById("event-modal")) return;
      let modal = document.createElement("div");
      modal.id = "event-modal";
      modal.innerHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 300px; z-index: 10000;">
          <h3 style="margin-bottom: 15px; font-size: 18px; font-weight: 600; color: #333;">${event ? "Edit Event" : "Add New Event"}</h3>
          <input type="text" id="edit-title" value="${event ? event.title : ""}" style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px;" placeholder="Event Title"/>
          <label style="font-size: 14px; margin-bottom: 10px; color: #333;"><input type="checkbox" id="all-day-checkbox" ${event && event.allDay ? "checked" : ""}/> All Day Event</label>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button id="save-btn" style="padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 14px;">${event ? "Save Changes" : "Add Event"}</button>
            ${event ? `<button id="duplicate-btn" style="padding: 10px; background: #FF9800; color: white; border: none; border-radius: 5px; font-size: 14px;">Duplicate</button>
            <button id="delete-btn" style="padding: 10px; background: #F44336; color: white; border: none; border-radius: 5px; font-size: 14px;">Delete</button>` : ""}
            <button id="close-btn" style="padding: 10px; background: #9E9E9E; color: white; border: none; border-radius: 5px; font-size: 14px;">Cancel</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      // Save or Add
      document.getElementById("save-btn").addEventListener("click", function () {
        let newTitle = document.getElementById("edit-title").value.trim();
        if (!newTitle) return alert("Title cannot be empty");
        let isAllDay = document.getElementById("all-day-checkbox").checked;
        let eventData = {
          title: newTitle,
          start: selectionInfo ? selectionInfo.startStr : event.start.toISOString(),
          end: selectionInfo ? selectionInfo.endStr : event.end.toISOString(),
          allDay: isAllDay
        };
        if (isAllDay) {
          let startDate = new Date(eventData.start);
          let endDate = new Date(eventData.end);
          startDate.setHours(0, 0, 0, 0);
          endDate.setHours(0, 0, 0, 0);
          eventData.start = startDate.toISOString();
          eventData.end = endDate.toISOString();
        }
        let url = event ? "/update-event" : "/add-event";
        let method = event ? "PUT" : "POST";
        let bodyData = event ? { id: event.id, title: newTitle } : eventData;
        fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(bodyData) })
          .then((response) => response.json())
          .then((data) => {
            if (!event) { eventData.id = data.id; calendar.addEvent(eventData); }
            else { event.setProp("title", newTitle); }
          })
          .catch((error) => alert("Failed to save event."));
        closeEventModal();
      });

      // Duplicate
      if (event) {
        document.getElementById("duplicate-btn").addEventListener("click", function () {
          let duplicateEvent = {
            title: event.title,
            start: new Date(event.end).toISOString(),
            end: new Date(new Date(event.end).getTime() + (event.end - event.start)).toISOString(),
            allDay: event.allDay
          };
          fetch("/add-event", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(duplicateEvent) })
            .then((response) => response.json())
            .then((data) => { duplicateEvent.id = data.id; calendar.addEvent(duplicateEvent); })
            .catch((error) => alert("Failed to duplicate event."));
          closeEventModal();
        });

        // Delete
        document.getElementById("delete-btn").addEventListener("click", function () {
          if (confirm("Are you sure you want to delete this event?")) {
            fetch(`/delete-event/${event.id}`, { method: "DELETE" })
              .then(() => event.remove())
              .catch((error) => alert("Failed to delete event."));
          }
          closeEventModal();
        });
      }

      // Cancel
      document.getElementById("close-btn").addEventListener("click", function () { closeEventModal(); });
    }

    function closeEventModal() {
      let modal = document.getElementById("event-modal");
      if (modal) modal.remove();
    }
  });
</script>
{% endblock %}

