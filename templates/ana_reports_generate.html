{% extends "base.html" %}

{% block title %}Analytical Reports{% endblock %}

{% block content %}
<style>
  .surface-card { box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.10); }
  .ring-muted   { box-shadow: 0 0 0 1px rgba(16,24,40,.08) inset; }
  .dark-mode .analytical-page .surface-card { background-color: #111827 !important; color: #e5e7eb !important; }
  .dark-mode .analytical-page .ring-muted   { box-shadow: 0 0 0 1px rgba(255,255,255,.12) inset; }
  .dark-mode .analytical-page .text-gray-900 { color: #e5e7eb !important; }
  .dark-mode .analytical-page .text-gray-700 { color: #cbd5e1 !important; }
  .dark-mode .analytical-page .text-gray-500 { color: #9ca3af !important; }
  .dark-mode .analytical-page .bg-white { background-color: #111827 !important; }
  .dark-mode .analytical-page .border-gray-200 { border-color: #374151 !important; }

  .delete-report-btn {
    border: 1px solid rgba(248, 113, 113, 0.4);
    background: rgba(248, 113, 113, 0.12);
    color: #dc2626;
  }
  .delete-report-btn:hover {
    background: rgba(239, 68, 68, 0.18);
    color: #b91c1c;
  }
  .dark-mode .delete-report-btn {
    border-color: rgba(252, 165, 165, 0.3);
    background: rgba(239, 68, 68, 0.22);
    color: #fecaca;
  }
  .dark-mode .delete-report-btn:hover {
    background: rgba(248, 113, 113, 0.28);
    color: #fca5a5;
  }

  .analytical-terminal {
    background: rgba(15, 23, 42, 0.92);
    border: 1px solid rgba(148, 163, 184, 0.18);
    border-radius: 0.9rem;
    color: #e2e8f0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 18px 45px -18px rgba(15, 23, 42, 0.65);
  }
  .dark-mode .analytical-terminal { background: rgba(17, 24, 39, 0.95); }

  .analytical-terminal .terminal-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.85rem 1.1rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.16);
    background: linear-gradient(145deg, rgba(24, 37, 64, 0.82), rgba(17, 24, 39, 0.85));
  }
  .terminal-title {
    display: block;
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #94a3b8;
  }
  .terminal-meta {
    margin-top: 0.2rem;
    font-size: 0.7rem;
    color: rgba(203, 213, 225, 0.85);
  }

  .terminal-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.4rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: background 0.2s ease, color 0.2s ease;
  }
  .terminal-status-badge[data-status="idle"]        { background: rgba(148, 163, 184, 0.16); color: #cbd5f5; }
  .terminal-status-badge[data-status="queued"]      { background: rgba(14, 165, 233, 0.18); color: #0ea5e9; }
  .terminal-status-badge[data-status="started"]     { background: rgba(79, 70, 229, 0.2); color: #818cf8; }
  .terminal-status-badge[data-status="finished"]    { background: rgba(34, 197, 94, 0.18); color: #34d399; }
  .terminal-status-badge[data-status="failed"]      { background: rgba(248, 113, 113, 0.18); color: #f87171; }
  .terminal-status-badge[data-status="disconnected"]{ background: rgba(251, 191, 36, 0.18); color: #fbbf24; }

  .terminal-status-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    background: currentColor;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.08);
  }
  .terminal-count {
    font-size: 0.7rem;
    font-weight: 600;
    color: #94a3b8;
  }
  .terminal-cancel {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.85rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    background: rgba(248, 113, 113, 0.18);
    color: #f87171;
    border: 1px solid rgba(248, 113, 113, 0.32);
    transition: background 0.2s ease, color 0.2s ease, opacity 0.2s ease;
  }
  .terminal-cancel:hover:not(:disabled) {
    background: rgba(248, 113, 113, 0.28);
    color: #fecaca;
  }
  .terminal-cancel:disabled {
    opacity: 0.45;
    cursor: not-allowed;
  }
  .terminal-cancel svg {
    width: 1rem;
    height: 1rem;
  }
  .dark-mode .terminal-cancel {
    background: rgba(248, 113, 113, 0.25);
    border-color: rgba(248, 113, 113, 0.35);
    color: #fecaca;
  }
  .dark-mode .terminal-cancel:hover:not(:disabled) {
    background: rgba(248, 113, 113, 0.35);
    color: #fee2e2;
  }
  .terminal-clear {
    border: 1px solid rgba(148, 163, 184, 0.2);
    background: rgba(30, 58, 138, 0.18);
    color: #cbd5f5;
    font-size: 0.7rem;
    padding: 0.35rem 0.7rem;
    border-radius: 9999px;
    transition: background 0.2s ease, opacity 0.2s ease;
  }
  .terminal-clear:disabled { opacity: 0.4; cursor: not-allowed; }
  .terminal-clear:hover:not(:disabled) { background: rgba(59, 130, 246, 0.38); }

  /* Spinner shown while generating */
  .spinner {
    display: inline-flex;
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(148, 163, 184, 0.35);
    border-top-color: #60a5fa;
    border-radius: 9999px;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .terminal-log {
    background: rgba(15, 23, 42, 0.86);
    padding: 0.85rem 1.1rem;
    max-height: 22rem;
    overflow-y: auto;
  }
  /* Timeline (replaces terminal log visuals) */
  .timeline-root { padding: 0.85rem 0.2rem; max-height: 22rem; overflow-y: auto; }
  .timeline-progress {
    position: relative;
    height: 8px;
    border-radius: 9999px;
    background: rgba(99, 102, 241, 0.18);
    overflow: hidden;
    margin: 0.5rem 0.9rem 0.8rem;
  }
  .timeline-progress > span {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0%;
    background: linear-gradient(90deg, rgba(59,130,246,.9), rgba(99,102,241,.9));
    box-shadow: 0 8px 18px -8px rgba(59, 130, 246, 0.6);
    border-radius: 9999px;
    transition: width .3s ease;
  }
  .timeline-list { display: grid; gap: 0.65rem; padding: 0.25rem 0.9rem 0.9rem; }
  .timeline-item { display: grid; grid-template-columns: 18px 1fr; gap: 0.6rem; align-items: flex-start; }
  .timeline-marker {
    width: 18px; height: 18px; border-radius: 9999px;
    background: rgba(148, 163, 184, 0.35);
    border: 2px solid rgba(148, 163, 184, 0.45);
    position: relative; margin-top: 2px;
  }
  .timeline-marker::after {
    content: ""; position: absolute; left: 50%; top: 18px; transform: translateX(-50%);
    width: 2px; height: calc(100% - 18px); background: rgba(148, 163, 184, 0.25);
  }
  .timeline-item:last-child .timeline-marker::after { display: none; }
  .timeline-content { display: flex; flex-direction: column; gap: 0.15rem; }
  .timeline-title { font-size: 0.85rem; font-weight: 600; color: #e2e8f0; }
  .timeline-meta { font-size: 0.7rem; color: rgba(148,163,184,.8); }
  .timeline-item.is-active .timeline-marker { background: rgba(59,130,246,.25); border-color: rgba(59,130,246,.65); }
  .timeline-item.is-active .timeline-title { color: #bfdbfe; }
  .timeline-item.is-done .timeline-marker { background: rgba(34,197,94,.25); border-color: rgba(34,197,94,.7); }
  .timeline-item.is-done .timeline-title { color: #86efac; }
  .timeline-item.is-failed .timeline-marker { background: rgba(248,113,113,.25); border-color: rgba(248,113,113,.7); }
  .timeline-item.is-failed .timeline-title { color: #fecaca; }
  .terminal-empty {
    text-align: center;
    padding: 1.5rem 0;
    font-size: 0.85rem;
    color: #64748b;
  }

  .terminal-line {
    display: flex;
    gap: 0.7rem;
    padding: 0.4rem 0;
    border-bottom: 1px solid rgba(148, 163, 184, 0.08);
  }
  .terminal-line:last-child { border-bottom: none; }
  .terminal-line-index {
    min-width: 2.1rem;
    text-align: right;
    font-weight: 600;
    color: #38bdf8;
  }
  .terminal-line-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }
  .terminal-line-meta {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(148, 163, 184, 0.7);
  }
  .terminal-line-text {
    color: #e2e8f0;
    word-break: break-word;
  }
  .terminal-line[data-type="user_message"] .terminal-line-text { color: #facc15; }
  .terminal-line[data-type="user_message"] .terminal-line-index { color: #facc15; }
  .terminal-line[data-type="error"] .terminal-line-text { color: #fca5a5; }
  .terminal-line[data-type="completed"] .terminal-line-text { color: #86efac; }
  .terminal-line[data-type="status"] .terminal-line-text { color: #93c5fd; }
  .terminal-line[data-origin="user"] .terminal-line-body { align-items: flex-end; }
  .terminal-line--recent { animation: terminalFlash 0.6s ease-out; }
  @keyframes terminalFlash {
    0% { background-color: rgba(59, 130, 246, 0.18); }
    100% { background-color: transparent; }
  }

  .terminal-link {
    margin-left: 0.5rem;
    color: #38bdf8;
    font-weight: 600;
    text-decoration: underline;
  }

  .terminal-alert {
    margin: 0.8rem 1.1rem 0;
    border-radius: 0.7rem;
    border: 1px solid transparent;
    padding: 0.65rem 0.85rem;
    font-size: 0.8rem;
    display: none;
  }
  .terminal-alert[data-variant] { display: block; }
  .terminal-alert[data-variant="info"] { background: rgba(59, 130, 246, 0.13); color: #60a5fa; border-color: rgba(59, 130, 246, 0.25); }
  .terminal-alert[data-variant="warning"] { background: rgba(251, 191, 36, 0.18); color: #fbbf24; border-color: rgba(251, 191, 36, 0.28); }
  .terminal-alert[data-variant="error"] { background: rgba(248, 113, 113, 0.18); color: #f87171; border-color: rgba(248, 113, 113, 0.35); }
  .terminal-alert.hidden { display: none; }

  .prompt-stack {
    margin: 0.65rem 1.1rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .prompt-stack.hidden { display: none; }
  .prompt-card {
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 0.8rem;
    padding: 0.85rem 0.95rem;
    background: rgba(17, 24, 39, 0.82);
  }
  .prompt-card-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #bfdbfe;
  }
  .prompt-card-body {
    margin-top: 0.35rem;
    font-size: 0.78rem;
    color: #cbd5f5;
  }
  .prompt-card-hint {
    margin-top: 0.35rem;
    font-size: 0.7rem;
    color: rgba(148, 163, 184, 0.75);
  }
  .prompt-card-actions {
    margin-top: 0.7rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .prompt-card-actions button {
    font-size: 0.75rem;
    padding: 0.45rem 0.85rem;
    border-radius: 0.55rem;
  }
  .prompt-card-input {
    flex: 1;
    min-width: 12rem;
    border-radius: 0.55rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: rgba(15, 23, 42, 0.92);
    padding: 0.5rem 0.65rem;
    color: #e2e8f0;
  }
  .prompt-card-input::placeholder { color: rgba(148, 163, 184, 0.65); }
  .prompt-card-submit {
    padding: 0.5rem 0.9rem;
    border-radius: 0.6rem;
    font-size: 0.75rem;
  }
  .match-confirm-card {
    background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.16), rgba(17, 24, 39, 0.92));
    border: 1px solid rgba(99, 102, 241, 0.35);
    box-shadow: 0 18px 32px -22px rgba(37, 99, 235, 0.45);
  }
  .match-confirm-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    background: rgba(59, 130, 246, 0.25);
    color: #bfdbfe;
  }
  .match-confirm-title {
    margin-top: 0.8rem;
    font-size: 1.05rem;
    font-weight: 600;
    color: #e2e8f0;
  }
  .match-confirm-question {
    margin-top: 0.6rem;
    font-size: 0.82rem;
    color: rgba(226, 232, 240, 0.85);
  }
  .match-confirm-details {
    margin-top: 0.9rem;
    display: grid;
    gap: 0.6rem;
  }
  .match-confirm-detail {
    border-radius: 0.75rem;
    padding: 0.65rem 0.75rem;
    background: rgba(30, 64, 175, 0.4);
    color: #e0e7ff;
    font-size: 0.78rem;
    border: 1px solid rgba(59, 130, 246, 0.32);
  }
  .match-confirm-actions {
    margin-top: 1.1rem;
    display: grid;
    gap: 0.6rem;
  }
  @media (min-width: 480px) {
    .match-confirm-actions {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  .match-confirm-btn {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.2rem;
    border-radius: 0.8rem;
    padding: 0.8rem 1rem;
    border: 1px solid transparent;
    text-align: left;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }
  .match-confirm-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 28px -18px rgba(59, 130, 246, 0.45);
  }
  .match-confirm-btn--primary {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.65), rgba(99, 102, 241, 0.7));
    color: #f8fafc;
  }
  .match-confirm-btn--secondary {
    background: rgba(15, 23, 42, 0.65);
    border-color: rgba(148, 163, 184, 0.32);
    color: #cbd5f5;
  }
  .match-confirm-btn-title {
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.04em;
  }
  .match-confirm-btn-subtitle {
    font-size: 0.7rem;
    opacity: 0.75;
  }
  .match-confirm-hint {
    margin-top: 0.9rem;
    font-size: 0.72rem;
    color: rgba(203, 213, 225, 0.8);
  }

  .terminal-input {
    width: calc(100% - 2.2rem);
    margin: 0 1.1rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .terminal-input-field {
    flex: 1;
    border-radius: 0.7rem;
    border: 1px solid rgba(148, 163, 184, 0.22);
    background: rgba(15, 23, 42, 0.9);
    padding: 0.65rem 0.75rem;
    color: #e2e8f0;
    font-family: "JetBrains Mono", "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.85rem;
  }
  .terminal-input-field:focus {
    outline: none;
    border-color: rgba(99, 102, 241, 0.6);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
  }
  .terminal-input-field:disabled { opacity: 0.45; cursor: not-allowed; }
  .terminal-send {
    padding: 0.6rem 1rem;
    border-radius: 0.7rem;
    font-size: 0.74rem;
    border: 1px solid rgba(148, 163, 184, 0.22);
    color: #e2e8f0;
    background: rgba(59, 130, 246, 0.2);
    transition: background 0.2s ease, opacity 0.2s ease;
  }
  .terminal-send:hover:not(:disabled) { background: rgba(59, 130, 246, 0.35); }
  .terminal-send:disabled { opacity: 0.4; cursor: not-allowed; }

  .latest-run-card {
    border: 1px solid rgba(16, 185, 129, 0.25);
    background: rgba(16, 185, 129, 0.08);
    border-radius: 0.85rem;
    padding: 1rem;
    box-shadow: 0 12px 30px -12px rgba(13, 148, 136, 0.32);
  }
  .latest-run-card.hidden { display: none; }
  .dark-mode .latest-run-card { background: rgba(5, 150, 105, 0.22); border-color: rgba(45, 212, 191, 0.28); }

  .report-preview-container {
    border: 1px solid rgba(148, 163, 184, 0.18);
    border-radius: 0.9rem;
    background: rgba(248, 250, 252, 0.92);
    padding: 1rem;
    box-shadow: 0 18px 35px -22px rgba(15, 23, 42, 0.4);
  }
  .report-preview-inner {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .report-preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }
  .report-preview-title {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #6366f1;
  }
  .report-preview-body {
    border: 1px solid rgba(148, 163, 184, 0.16);
    border-radius: 0.75rem;
    background: rgba(255, 255, 255, 0.96);
    overflow: auto;
    max-height: 26rem;
  }
  .report-preview-body::-webkit-scrollbar {
    height: 6px;
    width: 6px;
  }
  .report-preview-body::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.4);
    border-radius: 999px;
  }
  .report-preview-placeholder {
    padding: 1.5rem;
    text-align: center;
    font-size: 0.82rem;
    color: #6b7280;
  }
  .report-preview-table {
    width: 100%;
    min-width: 640px;
    border-collapse: collapse;
    font-size: 0.82rem;
  }
  .report-preview-table thead th {
    position: sticky;
    top: 0;
    padding: 0.75rem 0.85rem;
    text-align: left;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: 0.7rem;
    font-weight: 600;
    background: linear-gradient(120deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.18));
    color: #1f2937;
    border-bottom: 1px solid rgba(148, 163, 184, 0.28);
  }
  .report-preview-table tbody td {
    padding: 0.7rem 0.85rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.14);
    color: #1f2937;
    white-space: nowrap;
  }
  .report-preview-table tbody tr:nth-child(odd) td {
    background: rgba(226, 232, 240, 0.32);
  }
  .report-preview-table tbody tr:hover td {
    background: rgba(99, 102, 241, 0.12);
  }
  .report-preview-table img {
    max-height: 140px;
    width: auto;
    border-radius: 0.5rem;
    box-shadow: 0 8px 18px -16px rgba(59, 130, 246, 0.45);
  }
  .report-preview-cell-link {
    color: #2563eb;
    text-decoration: underline;
    font-weight: 600;
  }
  .report-preview-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: #64748b;
  }
  .report-preview-tabs {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    background: rgba(59, 130, 246, 0.06);
    border-radius: 9999px;
    padding: 0.35rem;
  }
  .report-preview-tab {
    border: 1px solid transparent;
    border-radius: 9999px;
    padding: 0.3rem 0.75rem;
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    background: rgba(255, 255, 255, 0.92);
    color: #1e3a8a;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
  }
  .report-preview-tab:hover { background: rgba(219, 234, 254, 0.9); }
  .report-preview-tab.is-active {
    background: linear-gradient(120deg, rgba(59, 130, 246, 0.9), rgba(99, 102, 241, 0.9));
    color: #ffffff;
    border-color: rgba(59, 130, 246, 0.25);
    box-shadow: 0 8px 18px -12px rgba(59, 130, 246, 0.8);
  }
  .report-preview-visual {
    border: 1px solid rgba(148, 163, 184, 0.16);
    border-radius: 0.75rem;
    background: rgba(255, 255, 255, 0.96);
    padding: 0.6rem;
    max-height: 28rem;
    overflow: auto;
  }
  .report-preview-visual img {
    width: 100%;
    height: auto;
    border-radius: 0.65rem;
    box-shadow: 0 12px 28px -18px rgba(15, 23, 42, 0.55);
  }
  .report-preview-link {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: #2563eb;
  }
  .report-preview-link:hover { color: #1d4ed8; }
  .report-preview-error {
    font-size: 0.78rem;
    color: #dc2626;
  }
  .dark-mode .report-preview-container {
    background: rgba(17, 24, 39, 0.94);
    border-color: rgba(55, 65, 81, 0.6);
    box-shadow: 0 20px 45px -28px rgba(0, 0, 0, 0.8);
  }
  .dark-mode .report-preview-title { color: #a5b4fc; }
  .dark-mode .report-preview-body {
    background: rgba(17, 24, 39, 0.92);
    border-color: rgba(55, 65, 81, 0.55);
  }
  .dark-mode .report-preview-placeholder { color: #94a3b8; }
  .dark-mode .report-preview-table thead th {
    background: linear-gradient(120deg, rgba(79, 70, 229, 0.18), rgba(14, 165, 233, 0.16));
    color: #e5e7eb;
    border-bottom-color: rgba(148, 163, 184, 0.22);
  }
  .dark-mode .report-preview-table tbody td {
    color: #cbd5f5;
    border-bottom-color: rgba(55, 65, 81, 0.55);
  }
  .dark-mode .report-preview-table tbody tr:nth-child(odd) td {
    background: rgba(30, 41, 59, 0.6);
  }
  .dark-mode .report-preview-table tbody tr:hover td {
    background: rgba(79, 70, 229, 0.28);
  }
  .dark-mode .report-preview-table img {
    box-shadow: 0 8px 20px -16px rgba(14, 165, 233, 0.55);
  }
  .dark-mode .report-preview-cell-link {
    color: #93c5fd;
  }
  .dark-mode .report-preview-footer { color: #9ca3af; }
  .dark-mode .report-preview-link { color: #93c5fd; }
  .dark-mode .report-preview-link:hover { color: #60a5fa; }
  .dark-mode .report-preview-error { color: #fca5a5; }
  .dark-mode .report-preview-tabs {
    background: rgba(79, 70, 229, 0.25);
  }
  .dark-mode .report-preview-tab {
    background: rgba(17, 24, 39, 0.92);
    color: #cbd5f5;
    border-color: rgba(79, 70, 229, 0.25);
  }
  .dark-mode .report-preview-tab:hover {
    background: rgba(37, 99, 235, 0.28);
    color: #e0e7ff;
  }
  .dark-mode .report-preview-tab.is-active {
    border-color: rgba(79, 70, 229, 0.5);
    box-shadow: 0 10px 24px -18px rgba(14, 165, 233, 0.75);
  }
  .dark-mode .report-preview-visual {
    background: rgba(17, 24, 39, 0.92);
    border-color: rgba(55, 65, 81, 0.55);
  }

  /* Enhanced inline report styling (shared with overview) */
  .report-stat-card--overall { border-left: 4px solid rgba(59, 130, 246, 0.6); }
  .report-stat-card--defence { border-left: 4px solid rgba(56, 189, 248, 0.7); }
  .report-stat-card--attack { border-left: 4px solid rgba(249, 115, 22, 0.7); }
  .report-stat-card.is-positive {
    background: linear-gradient(120deg, rgba(16, 185, 129, 0.18), rgba(34, 197, 94, 0.08));
    border-color: rgba(16, 185, 129, 0.35);
  }
  .report-stat-card.is-negative {
    background: linear-gradient(120deg, rgba(248, 113, 113, 0.18), rgba(239, 68, 68, 0.08));
    border-color: rgba(248, 113, 113, 0.35);
  }
  .report-stat-card.is-neutral {
    background: linear-gradient(120deg, rgba(148, 163, 184, 0.1), rgba(226, 232, 240, 0.08));
    border-color: rgba(148, 163, 184, 0.25);
  }
  .report-rate {
    font-weight: 600;
  }
  .report-rate.is-positive { color: #16a34a; }
  .report-rate.is-negative { color: #dc2626; }
  .report-rate.is-neutral { color: #475569; }
  .report-count { font-weight: 600; color: #1f2937; }
  .report-agent-stack {
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem;
  }
  .report-agent-chip {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 0.35rem;
    padding: 0.35rem 0.6rem;
    border-radius: 0.75rem;
    background: rgba(59, 130, 246, 0.12);
    color: #1e3a8a;
    font-size: 0.72rem;
    font-weight: 600;
  }
  .report-agent-chip-head {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }
  .report-agent-chip-head span {
    font-weight: 600;
  }
  .report-agent-chip img {
    width: 34px;
    height: 34px;
    border-radius: 0.55rem;
    object-fit: cover;
    box-shadow: 0 6px 16px -10px rgba(59, 130, 246, 0.6);
  }
  .report-agent-player {
    font-size: 0.65rem;
    font-weight: 500;
    color: #1f2937;
  }
  .report-visual-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
  }
  .report-visual-card {
    border: 1px solid rgba(148, 163, 184, 0.18);
    border-radius: 0.85rem;
    background: rgba(248, 250, 252, 0.9);
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .report-visual-card span {
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #475569;
  }
  .report-visual-trigger {
    border: none;
    padding: 0;
    background: transparent;
    cursor: zoom-in;
  }
  .report-visual-trigger:focus-visible {
    outline: 2px solid #6366f1;
    outline-offset: 2px;
  }
  .report-lightbox {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  }
  .report-lightbox.is-open { display: flex; }
  .report-lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.75);
  }
  .report-lightbox-content {
    position: relative;
    z-index: 1;
    background: rgba(15, 23, 42, 0.95);
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 25px 60px -20px rgba(15, 23, 42, 0.8);
    max-width: 90vw;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .report-lightbox-image {
    width: 100%;
    height: auto;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 0.75rem;
    box-shadow: 0 18px 45px -20px rgba(15, 23, 42, 0.75);
  }
  .report-lightbox-caption {
    font-size: 0.75rem;
    color: #e2e8f0;
    text-align: center;
  }
  .report-lightbox-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    border: none;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.85);
    color: #f8fafc;
    width: 34px;
    height: 34px;
    font-size: 1.25rem;
    line-height: 1;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px -12px rgba(15, 23, 42, 0.9);
  }
  .report-visual-card img {
    max-height: 420px;
    object-fit: contain;
  }
  .dark-mode .report-stat-card.is-positive {
    background: linear-gradient(120deg, rgba(34, 197, 94, 0.25), rgba(16, 185, 129, 0.12));
    border-color: rgba(16, 185, 129, 0.4);
  }
  .dark-mode .report-stat-card.is-negative {
    background: linear-gradient(120deg, rgba(248, 113, 113, 0.28), rgba(239, 68, 68, 0.14));
    border-color: rgba(248, 113, 113, 0.4);
  }
  .dark-mode .report-stat-card.is-neutral {
    background: linear-gradient(120deg, rgba(148, 163, 184, 0.2), rgba(71, 85, 105, 0.15));
    border-color: rgba(148, 163, 184, 0.32);
  }
  .dark-mode .report-rate.is-positive { color: #4ade80; }
  .dark-mode .report-rate.is-negative { color: #f87171; }
  .dark-mode .report-rate.is-neutral { color: #cbd5f5; }
  .dark-mode .report-count { color: #e2e8f0; }
  .dark-mode .report-agent-chip {
    background: rgba(79, 70, 229, 0.28);
    color: #cbd5f5;
  }
  .dark-mode .report-agent-player {
    color: #dbeafe;
  }
  .dark-mode .report-lightbox-content {
    background: rgba(10, 12, 24, 0.95);
  }
  .dark-mode .report-lightbox-caption {
    color: #e2e8f0;
  }
  .dark-mode .report-lightbox-close {
    background: rgba(30, 41, 59, 0.8);
  }
  .dark-mode .surface-card { background-color: #0f172a !important; color: #e5e7eb !important; }
  .dark-mode .ring-muted   { box-shadow: 0 0 0 1px rgba(255,255,255,.10) inset; }
  .dark-mode .analytical-terminal { background: rgba(10, 15, 25, 0.96); border-color: rgba(148,163,184,0.18); }
  .dark-mode .analytical-terminal .terminal-top { background: linear-gradient(145deg, rgba(24,37,64,0.6), rgba(10,15,25,0.9)); border-bottom-color: rgba(148,163,184,0.18); }
  .dark-mode .terminal-title { color: #a5b4fc; }
  .dark-mode .terminal-meta { color: rgba(203, 213, 225, 0.8); }
  .dark-mode .terminal-status-badge[data-status] { background: rgba(148,163,184,0.12); color: #cbd5f5; }
  .dark-mode .report-detail { background: rgba(10, 15, 25, 0.98); border-color: rgba(55, 65, 81, 0.6); }
  .dark-mode .report-overview-card { background: rgba(15, 23, 42, 0.92); border-color: rgba(79, 70, 229, 0.22); }
  .dark-mode .report-visual-card { background: rgba(15, 23, 42, 0.92); border-color: rgba(79, 70, 229, 0.28); }
  .dark-mode .report-visual-card span { color: #a5b4fc; }
  .dark-mode .report-visual-card img { box-shadow: 0 12px 28px -18px rgba(14, 165, 233, 0.6); }
  .dark-mode .report-map-tab { background: rgba(79, 70, 229, 0.26); color: #cbd5f5; }
  .dark-mode .report-map-tab:hover { background: rgba(59, 130, 246, 0.34); color: #e0e7ff; }
  .dark-mode .report-map-tab.is-active { box-shadow: 0 14px 28px -18px rgba(14, 165, 233, 0.7); }
  .dark-mode .report-map-tab::after { background: rgba(129, 140, 248, 0.85); }
  .dark-mode .report-table { border-color: rgba(55, 65, 81, 0.55); }
  .dark-mode .report-table thead th { background: rgba(79, 70, 229, 0.26); color: #cbd5f5; }
  .dark-mode .report-table tbody td { color: #e5e7eb; border-top-color: rgba(31, 41, 55, 0.75); }
  .dark-mode .report-table tbody tr:nth-child(odd) td { background: rgba(31, 41, 55, 0.6); }
  /* Night mode: generator hero/description */
  .dark-mode .surface-card h2 { color: #e5e7eb; }
  .dark-mode .surface-card p { color: #cbd5e1; }
  .dark-mode .surface-card ul { color: #cbd5e1; }
  .dark-mode .surface-card .inline-flex.bg-indigo-500\/10 { background-color: rgba(165, 180, 252, 0.15); }
  .dark-mode .surface-card .text-indigo-600 { color: #c7d2fe; }

  /* Night mode: team selector form */
  .dark-mode #analytical-generator-form {
    background: rgba(2, 6, 23, 0.6);
    border-color: rgba(148, 163, 184, 0.22);
    box-shadow: 0 12px 32px -20px rgba(2, 6, 23, 0.9);
  }
  .dark-mode #analytical-generator-form .text-gray-500 { color: #cbd5e1; }
  .dark-mode #analytical-generator-form .text-gray-400 { color: #94a3b8; }
  .dark-mode #analytical-generator-form input[type="text"],
  .dark-mode #analytical-generator-form input[type="number"],
  .dark-mode #analytical-generator-form input[type="email"] {
    background-color: #0b1220;
    color: #e5e7eb;
    border-color: #334155;
  }
  .dark-mode #analytical-generator-form input::placeholder {
    color: #94a3b8;
  }
  .dark-mode #analytical-generator-form input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
  }
  .analytical-back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 0.75rem;
    border: 1px solid rgba(226, 232, 240, 1);
    background: rgba(255, 255, 255, 0.9);
    padding: 0.55rem 0.95rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: #374151;
    box-shadow: 0 10px 25px -18px rgba(15, 23, 42, 0.35);
    transition: background 0.2s ease, color 0.2s ease;
  }
  .analytical-back-link:hover { background: #f8fafc; }
  .analytical-back-link svg { color: inherit; }
  .dark-mode .analytical-back-link {
    background: rgba(17, 24, 39, 0.9);
    color: #d1d5db;
    border-color: rgba(75, 85, 99, 0.7);
    box-shadow: 0 10px 25px -18px rgba(0, 0, 0, 0.6);
  }
  .dark-mode .analytical-back-link:hover { background: rgba(31, 41, 55, 0.92); }

  .analytical-live-badge {
    display: inline-flex;
    align-items: center;
    border-radius: 0.75rem;
    padding: 0.45rem 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    color: #ffffff;
    background: #111827;
    box-shadow: 0 10px 18px -16px rgba(15, 23, 42, 0.55);
  }
  .analytical-live-badge::before {
    content: "";
    width: 0.5rem;
    height: 0.5rem;
    margin-right: 0.4rem;
    border-radius: 999px;
    background: #34d399;
    box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.25);
  }
  .dark-mode .analytical-live-badge {
    background: #1f2937;
    color: #f9fafb;
  }
  .report-detail {
    border: 1px solid rgba(148, 163, 184, 0.18);
    border-radius: 1rem;
    background: rgba(255, 255, 255, 0.98);
    padding: 1.25rem;
    box-shadow: 0 18px 35px -24px rgba(15, 23, 42, 0.45);
  }
  .report-detail-inner {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .report-detail-empty {
    padding: 1.25rem;
    border-radius: 0.9rem;
    border: 1px dashed rgba(148, 163, 184, 0.45);
    background: rgba(248, 250, 252, 0.9);
    font-size: 0.82rem;
    color: #475569;
  }
  .report-detail-loading {
    font-size: 0.82rem;
    color: #64748b;
  }
  .report-overview-card {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    padding: 1.25rem;
    border-radius: 1rem;
    background: rgba(248, 250, 252, 0.94);
    border: 1px solid rgba(148, 163, 184, 0.18);
  }
  .report-overview-brand {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
  }
  .report-overview-logo {
    width: 72px;
    height: 72px;
    border-radius: 1rem;
    object-fit: cover;
    border: 1px solid rgba(148, 163, 184, 0.18);
    background: #e2e8f0;
  }
  .report-overview-titles { flex: 1; min-width: 200px; }
  .report-overview-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    font-size: 0.78rem;
    color: #64748b;
  }
  .report-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.9rem;
    border-radius: 999px;
    background: rgba(59, 130, 246, 0.12);
    color: #1e3a8a;
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .report-stat-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  .report-stat-card {
    min-width: 150px;
    padding: 1rem;
    border-radius: 0.9rem;
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid rgba(148, 163, 184, 0.16);
    box-shadow: 0 10px 24px -18px rgba(15, 23, 42, 0.35);
  }
  .report-stat-card span {
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.68rem;
    color: #64748b;
    margin-bottom: 0.4rem;
    font-weight: 600;
  }
  .report-stat-card strong {
    display: block;
    font-size: 1.2rem;
    color: #0f172a;
    font-weight: 600;
  }
  .report-stat-card small {
    display: block;
    font-size: 0.7rem;
    color: #94a3b8;
  }
  .report-scroll {
    overflow-x: auto;
    border-radius: 0.85rem;
  }
  .report-scroll::-webkit-scrollbar { height: 6px; }
  .report-scroll::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.35);
    border-radius: 999px;
  }
  .report-matches-table {
    width: 100%;
    min-width: 640px;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.82rem;
  }
  .report-matches-table thead th {
    padding: 0.65rem 0.75rem;
    text-align: left;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-size: 0.68rem;
    font-weight: 600;
    color: #475569;
    background: rgba(59, 130, 246, 0.1);
  }
  .report-matches-table tbody td {
    padding: 0.6rem 0.75rem;
    border-top: 1px solid rgba(148, 163, 184, 0.16);
    color: #0f172a;
    white-space: nowrap;
  }
  .report-matches-table tbody tr:nth-child(odd):not(.is-win):not(.is-loss) td {
    background: rgba(248, 250, 252, 0.85);
  }
  .report-matches-table tbody tr.is-win td {
    background: rgba(34, 197, 94, 0.16);
    color: #14532d;
    font-weight: 600;
  }
  .report-matches-table tbody tr.is-loss td {
    background: rgba(248, 113, 113, 0.18);
    color: #7f1d1d;
    font-weight: 600;
  }
  .report-matches-table tbody tr.is-win td:first-child,
  .report-matches-table tbody tr.is-loss td:first-child {
    border-left: 4px solid currentColor;
  }
  .report-matches-section {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1.25rem;
  }
  .report-performance-section {
    margin-top: 1.25rem;
  }
  .report-map-section {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .report-map-head {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    justify-content: space-between;
  }
  .report-map-tabs {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 0.45rem;
  }
  .report-map-tab {
    border: 1px solid transparent;
    border-radius: 999px;
    padding: 0.4rem 0.95rem;
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    background: rgba(59, 130, 246, 0.1);
    color: #1e3a8a;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
  }
  .report-map-tab:hover { background: rgba(59, 130, 246, 0.16); }
  .report-map-tab.is-active {
    background: linear-gradient(120deg, rgba(59, 130, 246, 0.92), rgba(99, 102, 241, 0.92));
    color: #ffffff;
    box-shadow: 0 12px 24px -16px rgba(59, 130, 246, 0.65);
  }
  .report-map-tab::after {
    content: "";
    position: absolute;
    left: 50%;
    bottom: -6px;
    transform: translateX(-50%) scaleX(0);
    width: 60%;
    height: 3px;
    border-radius: 999px;
    background: rgba(99, 102, 241, 0.85);
    transition: transform 0.2s ease;
  }
  .report-map-tab.is-active::after {
    transform: translateX(-50%) scaleX(1);
  }
  .report-map-panel {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .report-map-performance {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .report-map-performance-head {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }
  .report-subtitle {
    font-size: 0.76rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #475569;
    margin-bottom: 0.5rem;
  }
  .report-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.8rem;
    border-radius: 0.85rem;
    overflow: hidden;
    border: 1px solid rgba(148, 163, 184, 0.16);
  }
  .report-table thead th {
    padding: 0.55rem 0.7rem;
    text-align: left;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-size: 0.68rem;
    color: #1f2937;
    background: rgba(59, 130, 246, 0.12);
  }
  .report-table tbody td {
    padding: 0.55rem 0.7rem;
    border-top: 1px solid rgba(148, 163, 184, 0.12);
    color: #0f172a;
  }
  .report-table tbody tr:nth-child(odd) td {
    background: rgba(248, 250, 252, 0.72);
  }
  .report-table--map-performance tbody tr td {
    transition: background 0.2s ease, color 0.2s ease;
    cursor: pointer;
  }
  .report-map-name {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }
  .report-map-name .report-map-active-indicator {
    color: #4f46e5;
    font-size: 0.8rem;
    transform: translateY(-1px);
  }
  .report-map-name.is-active {
    font-weight: 700;
  }
  .report-table--map-performance tbody tr.is-positive td {
    background: rgba(34, 197, 94, 0.12);
    color: #166534;
    font-weight: 600;
  }
  .report-table--map-performance tbody tr.is-negative td {
    background: rgba(248, 113, 113, 0.16);
    color: #991b1b;
    font-weight: 600;
  }
  .report-table--map-performance tbody tr.is-neutral td {
    background: rgba(226, 232, 240, 0.35);
    color: #1f2937;
    font-weight: 600;
  }
  .report-table--map-performance tbody tr.is-active td {
    background: rgba(59, 130, 246, 0.12);
    color: #1f2937;
    font-weight: 600;
  }
  .report-postplant-table thead th:nth-child(2),
  .report-postplant-table thead th:nth-child(3),
  .report-postplant-table thead th:nth-child(4),
  .report-postplant-table thead th:nth-child(5) {
    background: rgba(59, 130, 246, 0.2);
    color: #1e3a8a;
  }
  .report-postplant-table tbody td:nth-child(2),
  .report-postplant-table tbody td:nth-child(3),
  .report-postplant-table tbody td:nth-child(4),
  .report-postplant-table tbody td:nth-child(5) {
    background: rgba(59, 130, 246, 0.08);
  }
  .report-postplant-table thead th:nth-child(6),
  .report-postplant-table thead th:nth-child(7),
  .report-postplant-table thead th:nth-child(8),
  .report-postplant-table thead th:nth-child(9) {
    background: rgba(249, 115, 22, 0.22);
    color: #7c2d12;
  }
  .report-postplant-table tbody td:nth-child(6),
  .report-postplant-table tbody td:nth-child(7),
  .report-postplant-table tbody td:nth-child(8),
  .report-postplant-table tbody td:nth-child(9) {
    background: rgba(249, 115, 22, 0.1);
  }
  .report-postplant-table tbody td:first-child {
    font-weight: 600;
    color: #1f2937;
  }
  .report-visual-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
  }
  .report-visual-card {
    border: 1px solid rgba(148, 163, 184, 0.18);
    border-radius: 0.85rem;
    background: rgba(248, 250, 252, 0.9);
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .report-visual-card span {
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #475569;
  }
  .report-visual-trigger {
    border: none;
    padding: 0;
    background: transparent;
    cursor: zoom-in;
  }
  .report-visual-trigger:focus-visible {
    outline: 2px solid #6366f1;
    outline-offset: 2px;
  }
  .report-lightbox {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  }
  .report-lightbox.is-open {
    display: flex;
  }
  .report-lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.75);
  }
  .report-lightbox-content {
    position: relative;
    z-index: 1;
    background: rgba(15, 23, 42, 0.95);
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 25px 60px -20px rgba(15, 23, 42, 0.8);
    max-width: 90vw;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .report-lightbox-image {
    width: 100%;
    height: auto;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 0.75rem;
    box-shadow: 0 18px 45px -20px rgba(15, 23, 42, 0.75);
  }
  .report-lightbox-caption {
    font-size: 0.75rem;
    color: #e2e8f0;
    text-align: center;
  }
  .report-lightbox-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    border: none;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.85);
    color: #f8fafc;
    width: 34px;
    height: 34px;
    font-size: 1.25rem;
    line-height: 1;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px -12px rgba(15, 23, 42, 0.9);
  }
  .report-lightbox-close:hover {
    background: rgba(37, 99, 235, 0.85);
  }
  .report-visual-card img {
    width: 100%;
    height: auto;
    border-radius: 0.7rem;
    box-shadow: 0 12px 28px -18px rgba(15, 23, 42, 0.55);
  }
  .dark-mode .report-detail {
    background: rgba(17, 24, 39, 0.95);
    border-color: rgba(55, 65, 81, 0.6);
    box-shadow: 0 24px 45px -30px rgba(0, 0, 0, 0.65);
  }
  .dark-mode .report-detail-empty {
    background: rgba(17, 24, 39, 0.9);
    border-color: rgba(79, 70, 229, 0.35);
    color: #cbd5f5;
  }
  .dark-mode .report-detail-loading { color: #94a3b8; }
  .dark-mode .report-overview-card {
    background: rgba(17, 24, 39, 0.9);
    border-color: rgba(79, 70, 229, 0.22);
  }
  .dark-mode .report-overview-logo { border-color: rgba(99, 102, 241, 0.28); }
  .dark-mode .report-overview-meta { color: #9ca3af; }
  .dark-mode .report-badge {
    background: rgba(79, 70, 229, 0.24);
    color: #cbd5f5;
  }
  .dark-mode .report-stat-card {
    background: rgba(15, 23, 42, 0.95);
    border-color: rgba(79, 70, 229, 0.25);
  }
  .dark-mode .report-stat-card span { color: #a5b4fc; }
  .dark-mode .report-stat-card strong { color: #e2e8f0; }
  .dark-mode .report-scroll::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.45);
  }
  .dark-mode .report-matches-table thead th {
    background: rgba(79, 70, 229, 0.28);
    color: #cbd5f5;
  }
  .dark-mode .report-matches-table tbody td {
    color: #e2e8f0;
    border-top-color: rgba(55, 65, 81, 0.65);
  }
  .dark-mode .report-matches-table tbody tr:nth-child(odd):not(.is-win):not(.is-loss) td {
    background: rgba(30, 41, 59, 0.6);
  }
  .dark-mode .report-matches-table tbody tr.is-win td {
    background: rgba(34, 197, 94, 0.24);
    color: #bbf7d0;
    font-weight: 600;
  }
  .dark-mode .report-matches-table tbody tr.is-loss td {
    background: rgba(248, 113, 113, 0.26);
    color: #fecaca;
    font-weight: 600;
  }
  .dark-mode .report-map-tab {
    background: rgba(79, 70, 229, 0.26);
    color: #cbd5f5;
  }
  .dark-mode .report-map-tab:hover {
    background: rgba(59, 130, 246, 0.34);
    color: #e0e7ff;
  }
  .dark-mode .report-map-tab.is-active {
    box-shadow: 0 14px 28px -18px rgba(14, 165, 233, 0.7);
  }
  .dark-mode .report-map-tab::after {
    background: rgba(129, 140, 248, 0.85);
  }
  .dark-mode .report-table {
    border-color: rgba(55, 65, 81, 0.55);
  }
  .dark-mode .report-table thead th {
    background: rgba(79, 70, 229, 0.26);
    color: #cbd5f5;
  }
  .dark-mode .report-table tbody td {
    color: #e5e7eb;
    border-top-color: rgba(31, 41, 55, 0.75);
  }
  .dark-mode .report-table tbody tr:nth-child(odd) td {
    background: rgba(31, 41, 55, 0.6);
  }
  .dark-mode .report-table--map-performance tbody tr.is-positive td {
    background: rgba(34, 197, 94, 0.24);
    color: #bbf7d0;
    font-weight: 600;
  }
  .dark-mode .report-table--map-performance tbody tr.is-negative td {
    background: rgba(248, 113, 113, 0.28);
    color: #fecaca;
    font-weight: 600;
  }
  .dark-mode .report-table--map-performance tbody tr.is-neutral td {
    background: rgba(76, 81, 146, 0.38);
    color: #e0e7ff;
    font-weight: 600;
  }
  .dark-mode .report-table--map-performance tbody tr.is-active td {
    background: rgba(129, 140, 248, 0.24);
    color: #f1f5f9;
    font-weight: 600;
  }
  .dark-mode .report-map-name .report-map-active-indicator {
    color: #a855f7;
  }
  .dark-mode .report-map-name.is-active {
    color: #ede9fe;
  }
  .dark-mode .report-postplant-table thead th:nth-child(2),
  .dark-mode .report-postplant-table thead th:nth-child(3),
  .dark-mode .report-postplant-table thead th:nth-child(4),
  .dark-mode .report-postplant-table thead th:nth-child(5) {
    background: rgba(99, 102, 241, 0.34);
    color: #e0e7ff;
  }
  .dark-mode .report-postplant-table tbody td:nth-child(2),
  .dark-mode .report-postplant-table tbody td:nth-child(3),
  .dark-mode .report-postplant-table tbody td:nth-child(4),
  .dark-mode .report-postplant-table tbody td:nth-child(5) {
    background: rgba(79, 70, 229, 0.2);
  }
  .dark-mode .report-postplant-table thead th:nth-child(6),
  .dark-mode .report-postplant-table thead th:nth-child(7),
  .dark-mode .report-postplant-table thead th:nth-child(8),
  .dark-mode .report-postplant-table thead th:nth-child(9) {
    background: rgba(249, 115, 22, 0.34);
    color: #fed7aa;
  }
  .dark-mode .report-postplant-table tbody td:nth-child(6),
  .dark-mode .report-postplant-table tbody td:nth-child(7),
  .dark-mode .report-postplant-table tbody td:nth-child(8),
  .dark-mode .report-postplant-table tbody td:nth-child(9) {
    background: rgba(234, 88, 12, 0.24);
  }
  .dark-mode .report-postplant-table tbody td:first-child {
    color: #f8fafc;
  }
  .dark-mode .report-visual-card {
    background: rgba(15, 23, 42, 0.92);
    border-color: rgba(79, 70, 229, 0.28);
  }
  .dark-mode .report-visual-card span { color: #a5b4fc; }
  .dark-mode .report-visual-card img {
    box-shadow: 0 12px 28px -18px rgba(14, 165, 233, 0.6);
  }
</style>
</style>

<div class="analytical-page mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Analytical Report Generator</h1>
      <p class="text-sm text-gray-500">Launch, monitor, and complete the live analytical report workflow.</p>
    </div>
    <div class="flex flex-col items-start gap-2 sm:items-end">
      <a
        href="{{ url_for('analytical') }}"
        class="analytical-back-link"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7" />
        </svg>
        Back to overview
      </a>
      <span class="analytical-live-badge">Live workspace</span>
    </div>
  </div>

  {% if not redis_available %}
  <div class="mb-6 rounded-lg border border-yellow-300 bg-yellow-50 px-4 py-3 text-sm text-yellow-800">
    Live generation is temporarily offline. Start your Redis server (e.g. <code>redis-server</code>) and the bundled worker
    script (<code>python rq_worker.py</code>) to re-enable the streaming terminal.
  </div>
  {% endif %}

  {% if error %}
  <div class="mb-6 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
    {{ error }}
  </div>
  {% endif %}

  <div class="relative mb-10 overflow-hidden rounded-2xl surface-card ring-muted">
    <div class="pointer-events-none absolute inset-0 bg-gradient-to-br from-indigo-500/15 via-sky-500/10 to-emerald-500/15"></div>
    <div class="relative px-6 py-8 lg:px-10">
      <div class="space-y-4">
        <span class="inline-flex items-center rounded-full bg-indigo-500/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-600">Generator</span>
        <h2 class="text-2xl font-semibold text-gray-900">Create a new analytical report</h2>
        <p class="text-sm leading-relaxed text-gray-600">
          Enter the team, the number of most recent matches to analyze, and your mail adress to receive the report. Follow the progress immediately through the live terminal.
        </p>
        <ul class="space-y-2 text-sm text-gray-600">
          <li class="flex items-start gap-2">
            <span class="mt-1 inline-flex h-2.5 w-2.5 flex-shrink-0 rounded-full bg-indigo-500"></span>
            <span>Generates an overall summary, and a per-map breakdown, including comp anaysis, post-plant performance, and a visual breakdown.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-1 inline-flex h-2.5 w-2.5 flex-shrink-0 rounded-full bg-emerald-500"></span>
            <span>The report can be viewed in the website or opened in a Google Sheet document, which is also shared via email.</span>
          </li>
        </ul>
      </div>

      <div class="mt-6 grid gap-8 lg:grid-cols-2">
        <div>
          <form
            id="analytical-generator-form"
            action="{{ url_for('create_analytical_job') }}"
            method="post"
            class="rounded-xl border border-gray-100 bg-white/80 p-6 shadow-sm backdrop-blur"
          >
          <div class="space-y-5">
            <label class="block">
              <span class="text-xs font-semibold uppercase text-gray-500">Team</span>
              <input
                type="text"
                name="team"
                list="team-options"
                placeholder="Start typing a team tag or name"
                value="{{ selected_team_input }}"
                required
                autocomplete="off"
                class="mt-1 block w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-inner focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                {% if not redis_available %}disabled{% endif %}
              />
              <datalist id="team-options">
                {% for team in teams %}
                <option value="{{ team.tag }}" label="{{ team.name }} ({{ team.tag }})"></option>
                <option value="{{ team.name }} ({{ team.tag }})"></option>
                {% endfor %}
              </datalist>
              <p class="mt-1 text-xs text-gray-400">Autocomplete suggestions show as you type; press Enter to accept.</p>
            </label>
            <label class="block">
              <span class="text-xs font-semibold uppercase text-gray-500">Nr. of Matches to include</span>
              <div class="mt-1 flex items-center gap-2">
                <input
                  type="number"
                  name="match_count"
                  min="1"
                  placeholder="All recent"
                  value="{{ match_count_value }}"
                  class="block w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-inner focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  {% if not redis_available %}disabled{% endif %}
                />
              </div>
            </label>
            <label class="block">
              <span class="text-xs font-semibold uppercase text-gray-500">Share report with</span>
              <div class="mt-1 flex items-center gap-2">
              <input
                type="email"
                name="share_email"
                placeholder="you@example.com"
                value="{{ share_email_value }}"
                class="mt-1 block w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-inner focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                {% if not redis_available %}disabled{% endif %}
              />
              <span class="text-xs text-gray-400">optional</span></div>
              <p class="mt-1 text-xs text-gray-400">Leave blank to fall back to the default configured address.</p>
            </label>
            <button
              type="submit"
              class="th-btn th-btn-primary inline-flex w-full items-center justify-center gap-2 py-2.5 text-sm font-semibold"
              id="initiate-generation-button"
              {% if not redis_available %}disabled{% endif %}
            >
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
              <span>Start generation</span>
            </button>
            <div id="generator-feedback" class="hidden rounded-lg border px-3 py-2 text-sm"></div>
            <p class="text-xs text-gray-500">
              Processing can take up to some minutes while match details, stats, and visual plots are created. The terminal
              updates instantly and keeps running even if you switch tabs.
            </p>
          </div>
          </form>

          <div id="latest-run-card" class="latest-run-card hidden mt-4">
            <div class="flex flex-col gap-3">
              <div>
                <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600">Latest run</p>
                <h3 id="latest-run-team" class="text-lg font-semibold text-gray-900"></h3>
                <p id="latest-run-meta" class="text-xs text-gray-600"></p>
              </div>
              <div class="flex flex-wrap gap-2">
                <a id="latest-run-link" class="th-btn th-btn-primary hidden" href="#" target="_blank" rel="noopener">Open report</a>
                <button type="button" id="latest-run-copy" class="th-btn th-btn-secondary hidden">Copy link</button>
                <button type="button" id="latest-run-save" class="th-btn th-btn-secondary hidden">Save to list</button>
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="analytical-terminal hidden" data-terminal-root>
            <div class="terminal-top">
              <div>
                <span class="terminal-title">Terminal • Analytical Generator</span>
                <span class="terminal-meta" id="terminal-team-label">Idle</span>
              </div>
              <div class="flex items-center gap-2">
                <button type="button" class="terminal-cancel hidden" id="terminal-cancel">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  <span>Cancel</span>
                </button>
                <span class="terminal-status-badge" id="terminal-status" data-status="idle">
                  <span class="terminal-status-dot" id="terminal-status-dot"></span>
                  <span id="terminal-status-text">Idle</span>
                </span>
                <span id="terminal-spinner" class="spinner hidden" aria-label="Working"></span>
                <span class="terminal-count" id="terminal-line-count">0%</span>
                <button type="button" class="terminal-clear hidden" id="terminal-clear" disabled>Clear</button>
              </div>
            </div>
            <div id="terminal-alert" class="terminal-alert hidden"></div>
            <div id="terminal-log" class="timeline-root">
              <div class="timeline-progress" aria-hidden="true"><span id="timeline-progress-bar" style="width:0%"></span></div>
              <div class="timeline-list" id="timeline-list"></div>
              <div class="terminal-empty text-gray-500" id="timeline-empty">Awaiting generation. Queue a report to see progress here.</div>
            </div>
            <div id="terminal-prompts" class="prompt-stack hidden"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="space-y-2">
    {% if all_reports and all_reports|length > 0 %}
      <div class="flex items-end justify-between mb-2">
        <div>
          <h2 class="text-lg font-semibold text-gray-900 dark-mode:text-gray-100">Latest report</h2>
          <p class="text-sm text-gray-500 dark-mode:text-gray-400">Most recent generated analytical report.</p>
        </div>
      </div>
      {% set entry = all_reports[0] %}
      {% set row_id = 'latest-report' %}
      <div
        class="surface-card bg-white rounded-xl p-4 ring-muted dark-mode:bg-gray-900/80"
        data-report-item
        data-spreadsheet-url="{{ entry.spreadsheet_url }}"
      >
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
          <div>
            <strong class="text-gray-900 dark-mode:text-gray-100">{{ entry.team_name }}</strong><br />
            <small class="text-gray-500 dark-mode:text-gray-400">Created: {{ entry.created_label }}</small>
            {% if entry.match_count %}
            <span class="ml-2 inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-semibold text-gray-600 dark-mode:bg-gray-800 dark-mode:text-gray-300">
              {{ entry.match_count }} matches
            </span>
            {% endif %}
            {% if entry.source == "saved" %}
            <span class="ml-2 inline-flex items-center rounded-full bg-indigo-100 px-2 py-0.5 text-xs font-semibold text-indigo-600 dark-mode:bg-indigo-900/50 dark-mode:text-indigo-200">
              Saved
            </span>
            {% endif %}
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <a
              class="th-btn th-btn-secondary"
              href="{{ entry.open_url }}"
              target="_blank"
              rel="noopener"
            >
              Open sheet
            </a>
            {% if entry.source == "saved" %}
            <button
              type="button"
              class="th-btn delete-report-btn"
              data-delete-report
              data-team-name="{{ entry.team_name }}"
              data-spreadsheet-url="{{ entry.spreadsheet_url }}"
            >
              Delete
            </button>
            {% endif %}
          </div>
        </div>

        {% if entry.report_payload %}
        <div
          class="report-detail mt-3"
          id="report-panel-{{ row_id }}"
          data-report-card
          data-report-payload='{{ entry.report_payload | tojson | forceescape }}'
          data-open-url="{{ entry.open_url }}"
          data-team-name="{{ entry.team_name }}"
          data-team-tag="{{ entry.team_tag or '' }}"
        >
          <div class="report-detail-inner">
            <section data-report-overview>
              <div class="report-detail-loading">Loading overview…</div>
            </section>
            <section class="report-map-section">
              <div class="report-map-head">
                <h4 class="report-subtitle text-gray-700 dark-mode:text-gray-200">Map breakdown</h4>
                <div class="report-map-tabs" data-report-tabs></div>
              </div>
              <div class="report-map-panel" data-report-map-panel>
                <div class="report-detail-loading">Select a map to inspect the detailed metrics.</div>
              </div>
            </section>
          </div>
        </div>
        {% else %}
        <div class="report-detail mt-3" id="report-panel-{{ row_id }}">
          <div class="report-detail-empty">
            Inline summary unavailable for this report. Use the “Open sheet” button to view it on Google Sheets.
          </div>
        </div>
        {% endif %}
      </div>
    {% else %}
      <div class="report-detail-empty">
        No reports yet. Generate a report above to see it here.
      </div>
    {% endif %}
  </div>
</div>

<script src="{{ url_for('static', filename='js/report-previews.js') }}"></script>
<script id="analytical-bootstrap" type="application/json">
{{ {
  "jobId": initial_job_id,
  "meta": initial_job_meta,
  "events": initial_terminal_events,
  "shareEmailDefault": share_email_default,
  "redisAvailable": redis_available
} | tojson }}
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const bootstrapEl = document.getElementById("analytical-bootstrap");
  let bootstrap = {};
  try {
    bootstrap = JSON.parse(bootstrapEl ? bootstrapEl.textContent || "{}" : "{}");
  } catch (error) {
    console.error("Failed to parse analytical bootstrap payload", error);
    bootstrap = {};
  }

  const state = {
    jobId: bootstrap.jobId || null,
    meta: bootstrap.meta || {},
    events: [],
    seenKeys: new Set(),
    eventSource: null,
    prompts: new Map(),
  };

  const redisAvailable = Boolean(bootstrap.redisAvailable);
  state.redisAvailable = redisAvailable;

  const elements = {
    generatorForm: document.getElementById("analytical-generator-form"),
    generatorButton: document.getElementById("initiate-generation-button"),
    generatorFeedback: document.getElementById("generator-feedback"),
    terminalRoot: document.querySelector("[data-terminal-root]"),
    terminalLog: document.getElementById("terminal-log"),
    timelineList: document.getElementById("timeline-list"),
    timelineEmpty: document.getElementById("timeline-empty"),
    timelineBar: document.getElementById("timeline-progress-bar"),
    terminalAlert: document.getElementById("terminal-alert"),
    terminalForm: document.getElementById("terminal-input-form"),
    messageInput: document.getElementById("terminal-message"),
    sendButton: document.querySelector("#terminal-input-form button[type='submit']"),
    statusBadge: document.getElementById("terminal-status"),
    statusText: document.getElementById("terminal-status-text"),
    statusDot: document.getElementById("terminal-status-dot"),
    spinner: document.getElementById("terminal-spinner"),
    lineCount: document.getElementById("terminal-line-count"),
    clearButton: document.getElementById("terminal-clear"),
    cancelButton: document.getElementById("terminal-cancel"),
    cancelLabel: document.querySelector("#terminal-cancel span"),
    promptStack: document.getElementById("terminal-prompts"),
    teamLabel: document.getElementById("terminal-team-label"),
    latestCard: document.getElementById("latest-run-card"),
    latestTeam: document.getElementById("latest-run-team"),
    latestMeta: document.getElementById("latest-run-meta"),
    latestLink: document.getElementById("latest-run-link"),
    latestSave: document.getElementById("latest-run-save"),
    latestCopy: document.getElementById("latest-run-copy"),
  };
  if (elements.cancelLabel && !elements.cancelLabel.dataset.defaultLabel) {
    elements.cancelLabel.dataset.defaultLabel = elements.cancelLabel.textContent || "Cancel";
  }

  const statusFallback = "idle";
  const normaliseStatus = (value) => {
    const raw = (value || "").toString().trim();
    return raw ? raw.toLowerCase() : statusFallback;
  };
  const activeStatuses = new Set(["queued", "started", "cancelling"]);
  const importantProgressPatterns = [
    /Job .* started/i,
    /Preparing match data/i,
    /Basic info gathered/i,
    /Creating per-map tabs/i,
    /Creating worksheet for map/i,
    /Spreadsheet ready/i,
    /Spreadsheet created/i,
    /Analytical report generated successfully/i,
    /Cancellation requested/i,
  ];
  const bannerVariants = {
    info: "info",
    warning: "warning",
    error: "error",
  };

  const toTitle = (value) =>
    (value || "")
      .toString()
      .replace(/[_-]/g, " ")
      .replace(/\b\w/g, (v) => v.toUpperCase());

  const formatTimestamp = (iso) => {
    if (!iso) return "";
    const date = new Date(iso);
    if (Number.isNaN(date.getTime())) return "";
    return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  };

  const eventKey = (evt) => {
    const payload = evt && evt.payload ? JSON.stringify(evt.payload) : "";
    return [evt.type || "progress", evt.origin || "system", evt.timestamp || "", payload].join("|");
  };

  const showBanner = (element, message, variant = "info") => {
    if (!element) return;
    element.textContent = message;
    element.dataset.variant = bannerVariants[variant] || bannerVariants.info;
    element.classList.remove("hidden");
  };

  const clearBanner = (element) => {
    if (!element) return;
    element.textContent = "";
    element.removeAttribute("data-variant");
    element.classList.add("hidden");
  };

  const isJobActive = () => Boolean(state.jobId) && activeStatuses.has(normaliseStatus(state.meta.status));

  const shouldDisplayProgressMessage = (message) => {
    if (!message) return false;
    return importantProgressPatterns.some((pattern) => pattern.test(message));
  };

  const syncLayout = () => {
    const active = isJobActive();
    if (elements.terminalRoot) {
      elements.terminalRoot.classList.toggle("hidden", !active);
    }
    if (elements.generatorForm) {
      elements.generatorForm.classList.toggle("hidden", active);
    }
  };

  const refreshTerminalControls = () => {
    const hasJob = Boolean(state.jobId) && redisAvailable;
    if (elements.messageInput) {
      if (!redisAvailable) {
        elements.messageInput.disabled = true;
      } else {
        elements.messageInput.disabled = !hasJob;
      }
      elements.messageInput.placeholder = !redisAvailable
        ? "Redis offline – start the service to enable input."
        : hasJob
        ? "Type a note or respond to prompts, then press Enter…"
        : "Start a generation to unlock the terminal.";
    }
    if (elements.sendButton) {
      elements.sendButton.disabled = !hasJob;
    }
    if (elements.clearButton) {
      elements.clearButton.disabled = true; // timeline has no clear
    }
    if (elements.spinner) {
      const active = isJobActive();
      elements.spinner.classList.toggle("hidden", !active);
      // Enforce inline display to prevent residual CSS animations when idle
      elements.spinner.style.display = active ? "inline-flex" : "none";
    }
    if (elements.cancelButton) {
      const status = normaliseStatus(state.meta.status);
      const visible = Boolean(state.jobId) && (activeStatuses.has(status) || status === "cancelling");
      elements.cancelButton.classList.toggle("hidden", !visible);
      elements.cancelButton.disabled = !activeStatuses.has(status) || status === "cancelling";
      if (elements.cancelLabel && !elements.cancelButton.disabled && elements.cancelLabel.dataset.defaultLabel) {
        elements.cancelLabel.textContent = elements.cancelLabel.dataset.defaultLabel;
      }
    }
  };

  const clearLog = (preserveSeen = true) => {
    if (elements.timelineList) {
      elements.timelineList.innerHTML = "";
    }
    state.events = [];
    state.timeline = initTimelineState();
    if (!preserveSeen) {
      state.seenKeys.clear();
    }
    if (elements.timelineEmpty) {
      elements.timelineEmpty.classList.remove("hidden");
    }
    if (elements.timelineBar) {
      elements.timelineBar.style.width = "0%";
    }
    if (elements.lineCount) {
      elements.lineCount.textContent = "0%";
    }
    refreshTerminalControls();
  };

  const updateTeam = (meta = {}) => {
    if (!elements.teamLabel) return;
    const parts = [];
    const teamName = meta.team_name || meta.teamName;
    const teamTag = meta.team_tag || meta.teamTag;
    const rawMatchCount = meta.match_count ?? meta.matchCount;
    const matchCount =
      rawMatchCount && rawMatchCount !== "None" && rawMatchCount !== "null" ? rawMatchCount : "";
    const shareEmail = meta.share_email || meta.shareEmail;

    if (teamName && teamTag) {
      parts.push(`${teamName} (${teamTag})`);
    } else if (teamName) {
      parts.push(teamName);
    } else if (teamTag) {
      parts.push(teamTag);
    }
    if (matchCount) {
      parts.push(`${matchCount} matches`);
    }
    if (shareEmail) {
      parts.push(`Share → ${shareEmail}`);
    }
    elements.teamLabel.textContent = parts.length ? parts.join(" • ") : "Idle";
  };

  const setStatus = (status, meta = {}) => {
    const finalStatus = status || statusFallback;
    const detail = meta && typeof meta === "object" ? { ...meta } : {};
    if (detail.meta && typeof detail.meta === "object") {
      Object.assign(detail, detail.meta);
      delete detail.meta;
    }
    state.meta = { ...state.meta, ...detail, status: finalStatus };
    if (elements.statusBadge) {
      elements.statusBadge.dataset.status = finalStatus;
    }
    if (elements.statusDot) {
      elements.statusDot.dataset.status = finalStatus;
    }
    if (elements.statusText) {
      elements.statusText.textContent = toTitle(finalStatus);
    }
    updateTeam(state.meta);
    refreshTerminalControls();
  };

  // Timeline logic
  const CHECKPOINTS = [
    { id: "started", label: "Job started", pattern: /Job .* started/i },
    { id: "prepare", label: "Preparing match data", pattern: /Preparing match data/i },
    { id: "basic", label: "Basic info gathered", pattern: /Basic info gathered/i },
    { id: "tabs", label: "Creating per-map tabs", pattern: /Creating per-map tabs/i },
    { id: "sheets", label: "Generating visualizations", pattern: /Creating worksheet for map|Spreadsheet (created|ready)/i },
    { id: "completed", label: "Report ready", pattern: /Analytical report generated successfully|completed/i },
  ];

  const initTimelineState = () => {
    const map = new Map();
    CHECKPOINTS.forEach((c, idx) => {
      map.set(c.id, { done: false, active: idx === 0, at: null });
    });
    return map;
  };

  state.timeline = initTimelineState();

  const computeProgress = () => {
    const per = 100 / CHECKPOINTS.length;
    let done = 0;
    CHECKPOINTS.forEach((c) => {
      if (state.timeline.get(c.id)?.done) done += 1;
    });
    return Math.min(100, Math.round(done * per));
  };

  const renderTimeline = () => {
    if (!elements.timelineList) return;
    elements.timelineList.innerHTML = "";
    let any = false;
    CHECKPOINTS.forEach((c, idx) => {
      const st = state.timeline.get(c.id);
      const item = document.createElement("div");
      item.className = "timeline-item";
      if (st?.done) item.classList.add("is-done"); else if (st?.active) item.classList.add("is-active");
      const marker = document.createElement("div"); marker.className = "timeline-marker";
      const body = document.createElement("div"); body.className = "timeline-content";
      const title = document.createElement("div"); title.className = "timeline-title"; title.textContent = c.label;
      body.appendChild(title);
      if (st?.at) { const meta = document.createElement("div"); meta.className = "timeline-meta"; meta.textContent = new Date(st.at).toLocaleTimeString(); body.appendChild(meta); }
      item.appendChild(marker); item.appendChild(body);
      elements.timelineList.appendChild(item);
      if (st?.done || st?.active) any = true;
      if (idx === CHECKPOINTS.length - 1 && state.meta.status === "failed") {
        item.classList.remove("is-done", "is-active"); item.classList.add("is-failed");
      }
    });
    if (elements.timelineEmpty) elements.timelineEmpty.classList.toggle("hidden", any);
    const pct = computeProgress();
    if (elements.timelineBar) elements.timelineBar.style.width = pct + "%";
    if (elements.lineCount) elements.lineCount.textContent = pct + "%";
  };

  const bumpCheckpoint = (message) => {
    if (!message) return false;
    let bumped = false;
    CHECKPOINTS.forEach((c, idx) => {
      if (c.pattern.test(message)) {
        const entry = state.timeline.get(c.id) || { done: false, active: idx === 0, at: null };
        if (!entry.done) {
          entry.done = true; entry.active = false; entry.at = new Date().toISOString();
          state.timeline.set(c.id, entry);
          const next = CHECKPOINTS[idx + 1];
          if (next) {
            const nxt = state.timeline.get(next.id) || { done: false, active: false, at: null };
            nxt.active = true; state.timeline.set(next.id, nxt);
          }
          bumped = true;
        }
      }
    });
    return bumped;
  };

  const appendLog = (evt) => {
    if (!elements.terminalLog) return;
    const key = eventKey(evt);
    if (state.seenKeys.has(key)) return;
    state.seenKeys.add(key);
    const payload = evt.payload || {};
    const message = payload.message || "";
    // Mark checkpoints on progress or completion
    if (evt.type === "progress") {
      bumpCheckpoint(message);
    } else if (evt.type === "completed") {
      bumpCheckpoint("Analytical report generated successfully");
    } else if (evt.type === "error") {
      state.meta.status = "failed";
    }
    state.events.push(evt);
    renderTimeline();
    refreshTerminalControls();
  };

  const dismissPrompt = (promptId) => {
    if (!promptId || !elements.promptStack) return;
    const card = state.prompts.get(promptId);
    if (card && card.parentNode) {
      card.parentNode.removeChild(card);
    }
    state.prompts.delete(promptId);
    if (!elements.promptStack.children.length) {
      elements.promptStack.classList.add("hidden");
    }
  };

  const isMatchConfirmPrompt = (payload) =>
    payload &&
    typeof payload.title === "string" &&
    payload.title.toLowerCase().includes("confirm match selection");

  const createMatchConfirmCard = (promptId, payload) => {
    const card = document.createElement("div");
    card.className = "prompt-card match-confirm-card";
    card.dataset.promptId = promptId;

    const chip = document.createElement("span");
    chip.className = "match-confirm-chip";
    chip.textContent = "Match selection";
    card.appendChild(chip);

    const heading = document.createElement("h3");
    heading.className = "match-confirm-title";
    heading.textContent = payload.title || "Confirm match selection";
    card.appendChild(heading);

    const lines = (payload.message || "")
      .split("\n")
      .map((line) => line.trim())
      .filter(Boolean);

    if (lines.length) {
      const question = document.createElement("p");
      question.className = "match-confirm-question";
      question.textContent = lines[0];
      card.appendChild(question);
    }

    const detailLines = lines.length > 1 ? lines.slice(1) : [];
    if (detailLines.length) {
      const details = document.createElement("div");
      details.className = "match-confirm-details";
      detailLines.forEach((line) => {
        const detail = document.createElement("div");
        detail.className = "match-confirm-detail";
        detail.textContent = line;
        details.appendChild(detail);
      });
      card.appendChild(details);
    }

    const actions = document.createElement("div");
    actions.className = "match-confirm-actions";

    const proceedButton = document.createElement("button");
    proceedButton.type = "button";
    proceedButton.className = "match-confirm-btn match-confirm-btn--primary";
    proceedButton.innerHTML = `
      <span class="match-confirm-btn-title">Proceed</span>
      <span class="match-confirm-btn-subtitle">Keep suggested matches</span>
    `;
    proceedButton.addEventListener("click", () => {
      sendUserMessage({ message: "yes", promptId });
      dismissPrompt(promptId);
    });
    actions.appendChild(proceedButton);

    const adjustButton = document.createElement("button");
    adjustButton.type = "button";
    adjustButton.className = "match-confirm-btn match-confirm-btn--secondary";
    adjustButton.innerHTML = `
      <span class="match-confirm-btn-title">Adjust selection</span>
      <span class="match-confirm-btn-subtitle">Pick a different count</span>
    `;
    adjustButton.addEventListener("click", () => {
      sendUserMessage({ message: "no", promptId });
      dismissPrompt(promptId);
    });
    actions.appendChild(adjustButton);

    card.appendChild(actions);

    if (payload.hint) {
      const hint = document.createElement("p");
      hint.className = "match-confirm-hint";
      hint.textContent = payload.hint;
      card.appendChild(hint);
    }

    return card;
  };

  const renderPrompt = (evt) => {
    const payload = evt.payload || {};
    const promptId = payload.id || payload.prompt_id || payload.promptId;
    if (!promptId || !elements.promptStack) {
      return;
    }
    if (state.prompts.has(promptId)) {
      return;
    }

    if (isMatchConfirmPrompt(payload)) {
      const card = createMatchConfirmCard(promptId, payload);
      elements.promptStack.appendChild(card);
      elements.promptStack.classList.remove("hidden");
      state.prompts.set(promptId, card);
      return;
    }

    const card = document.createElement("div");
    card.className = "prompt-card";
    card.dataset.promptId = promptId;

    const title = document.createElement("div");
    title.className = "prompt-card-title";
    title.textContent = payload.title || "Input required";
    card.appendChild(title);

    if (payload.message) {
      const description = document.createElement("div");
      description.className = "prompt-card-body";
      description.textContent = payload.message;
      card.appendChild(description);
    }

    if (payload.hint) {
      const hint = document.createElement("div");
      hint.className = "prompt-card-hint";
      hint.textContent = payload.hint;
      card.appendChild(hint);
    }

    const actions = document.createElement("div");
    actions.className = "prompt-card-actions";
    let hasAction = false;

    if (Array.isArray(payload.options) && payload.options.length) {
      payload.options.forEach((option) => {
        const value = typeof option === "string" ? option : option.value || option.label || "";
        const label = typeof option === "string" ? option : option.label || option.value || "Option";
        if (!value) return;
        const button = document.createElement("button");
        button.type = "button";
        button.className = "th-btn th-btn-secondary";
        button.textContent = label;
        button.addEventListener("click", () => {
          sendUserMessage({ message: value, promptId });
          dismissPrompt(promptId);
        });
        actions.appendChild(button);
        hasAction = true;
      });
    }

    if (payload.allow_free_text !== false) {
      const form = document.createElement("form");
      form.className = "flex items-center gap-2";
      const input = document.createElement("input");
      input.type = "text";
      input.name = "promptValue";
      input.className = "prompt-card-input";
      input.placeholder = payload.placeholder || "Type your response…";
      if (payload.default) {
        input.value = payload.default;
      }
      const submit = document.createElement("button");
      submit.type = "submit";
      submit.className = "prompt-card-submit th-btn th-btn-primary";
      submit.textContent = payload.submit_label || "Send";
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const value = input.value.trim();
        if (!value) {
          input.focus();
          return;
        }
        sendUserMessage({ message: value, promptId });
        dismissPrompt(promptId);
      });
      form.appendChild(input);
      form.appendChild(submit);
      actions.appendChild(form);
      hasAction = true;
    }

    if (!hasAction) {
      const acknowledge = document.createElement("button");
      acknowledge.type = "button";
      acknowledge.className = "th-btn th-btn-secondary";
      acknowledge.textContent = "Acknowledge";
      acknowledge.addEventListener("click", () => {
        sendUserMessage({ message: "Acknowledged", promptId });
        dismissPrompt(promptId);
      });
      actions.appendChild(acknowledge);
    }

    card.appendChild(actions);
    elements.promptStack.appendChild(card);
    elements.promptStack.classList.remove("hidden");
    state.prompts.set(promptId, card);
  };

  const updateLatestRun = (result, meta = {}) => {
    if (!elements.latestCard || !result || !result.spreadsheet_url) return;
    const teamName = result.team_name || meta.team_name || result.team_tag || "Unknown team";
    const matchCount = result.match_count ? `${result.match_count} matches` : "";
    const completed = meta.completed_at || meta.updated_at || new Date().toISOString();
    const completedText = new Date(completed).toLocaleString();

    if (elements.latestTeam) {
      elements.latestTeam.textContent = teamName;
    }
    if (elements.latestMeta) {
      const parts = [completedText];
      if (matchCount) parts.push(matchCount);
      elements.latestMeta.textContent = parts.join(" • ");
    }
    if (elements.latestLink) {
      const openUrl =
        result.spreadsheet_edit_url || result.spreadsheet_view_url || result.spreadsheet_url;
      if (openUrl) {
        elements.latestLink.href = openUrl;
        elements.latestLink.classList.remove("hidden");
      }
    }
    if (elements.latestCopy && result.spreadsheet_url) {
      elements.latestCopy.dataset.url = result.spreadsheet_url;
      elements.latestCopy.classList.remove("hidden");
    }
    if (elements.latestSave) {
      elements.latestSave.dataset.payload = JSON.stringify({
        report_team_name: teamName,
        report_team_tag: result.team_tag,
        report_spreadsheet_url: result.spreadsheet_url,
        report_spreadsheet_edit_url: result.spreadsheet_edit_url,
        report_spreadsheet_view_url: result.spreadsheet_view_url,
        report_spreadsheet_csv_url: result.spreadsheet_csv_url,
        report_spreadsheet_id: result.spreadsheet_id,
        report_match_count: result.match_count,
        report_created_at: completed,
        report_payload: result.report_payload || null,
      });
      elements.latestSave.classList.remove("hidden");
    }
    elements.latestCard.classList.remove("hidden");
    // Once the latest run card is visible, hide the spinner in the terminal header
    if (elements.spinner) {
      elements.spinner.classList.add("hidden");
    }
  };

  const handleEvent = (evt) => {
    switch (evt.type) {
      case "status":
        setStatus(evt.payload && evt.payload.status, evt.payload);
        appendLog(evt);
        // If status transitioned to a non-active state, make sure spinner is hidden
        if (elements.spinner && !isJobActive()) {
          elements.spinner.classList.add("hidden");
        }
        break;
      case "progress":
      case "user_message":
      case "error":
        appendLog(evt);
        if (evt.type === "error") {
          showBanner(elements.terminalAlert, evt.payload && evt.payload.message ? evt.payload.message : "Job failed.", "error");
          setStatus("failed", evt.payload || {});
          if (elements.spinner) elements.spinner.classList.add("hidden");
        }
        break;
      case "completed":
        appendLog(evt);
        setStatus("finished", evt.payload || {});
        if (elements.spinner) elements.spinner.classList.add("hidden");
        if (evt.payload && evt.payload.result) {
          updateLatestRun(evt.payload.result, evt.payload);
        }
        clearBanner(elements.terminalAlert);
        // Optionally collapse terminal after completion
        if (elements.terminalRoot) {
          elements.terminalRoot.classList.add("hidden");
        }
        if (elements.generatorForm) {
          elements.generatorForm.classList.remove("hidden");
        }
        break;
      case "prompt":
        appendLog(evt);
        renderPrompt(evt);
        break;
      case "prompt_resolved":
        appendLog(evt);
        {
          const payload = evt.payload || {};
          const promptId = payload.id || payload.prompt_id;
          if (promptId) {
            dismissPrompt(promptId);
          }
        }
        break;
      default:
        appendLog(evt);
        break;
    }
  };

  const attachEventSource = (jobId) => {
    if (!redisAvailable) return;
    if (!jobId) return;
    if (state.eventSource) {
      state.eventSource.close();
      state.eventSource = null;
    }
    try {
      const source = new EventSource(`/analytical_reports/jobs/${jobId}/stream`);
      state.eventSource = source;

      const consume = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleEvent(data);
        } catch (error) {
          console.error("Failed to parse SSE payload", error, event.data);
        }
      };

      ["status", "progress", "user_message", "error", "completed", "prompt", "prompt_resolved"].forEach((name) => {
        source.addEventListener(name, consume);
      });
      source.onmessage = consume;

      source.onopen = () => {
        clearBanner(elements.terminalAlert);
        setStatus(state.meta.status || "started", state.meta);
      };
      source.onerror = () => {
        showBanner(elements.terminalAlert, "Connection hiccup. Reconnecting…", "warning");
        setStatus("disconnected", state.meta);
      };
    } catch (error) {
      console.error("Failed to open SSE stream", error);
      showBanner(elements.terminalAlert, "Could not open live stream. Check Redis or network settings.", "error");
    }
  };

  const hydrateFromBootstrap = () => {
    if (Array.isArray(bootstrap.events)) {
      bootstrap.events.forEach((evt) => appendLog(evt));
    }
    if (state.meta && state.meta.status) {
      setStatus(state.meta.status, state.meta);
    } else if (state.events.length) {
      setStatus("started", state.meta);
    } else {
      setStatus(statusFallback, state.meta);
    }
    if (state.meta && state.meta.result) {
      updateLatestRun(state.meta.result, state.meta);
    }
    refreshTerminalControls();
    if (redisAvailable && state.jobId) {
      attachEventSource(state.jobId);
    }
  };

  const sendUserMessage = async ({ message, promptId = null }) => {
    if (!redisAvailable) {
      showBanner(
        elements.terminalAlert,
        "Redis is offline. Start Redis and the RQ worker to resume interactive runs.",
        "warning"
      );
      return;
    }
    if (!state.jobId || !message) {
      showBanner(elements.terminalAlert, "No active job. Queue a report first.", "warning");
      return;
    }
    try {
      const payload = { message };
      if (promptId) {
        payload.prompt_id = promptId;
      }
      const response = await fetch(`/analytical_reports/jobs/${state.jobId}/input`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        const body = await response.json().catch(() => ({}));
        const errorMessage = body.error || "Unable to send message.";
        showBanner(elements.terminalAlert, errorMessage, "error");
        return;
      }
      clearBanner(elements.terminalAlert);
    } catch (error) {
      console.error("Failed to send terminal input", error);
      showBanner(elements.terminalAlert, "Network error while sending input.", "error");
    }
  };

  const handleGeneratorSubmit = async (event) => {
    event.preventDefault();
    if (!elements.generatorForm) return;
    if (!redisAvailable) {
      showBanner(
        elements.generatorFeedback,
        "Redis is offline. Start Redis (e.g. `redis-server`) and an RQ worker before queuing jobs.",
        "error"
      );
      elements.generatorFeedback.classList.remove("hidden");
      return;
    }
    clearBanner(elements.generatorFeedback);
    if (elements.generatorButton) {
      elements.generatorButton.disabled = true;
      elements.generatorButton.dataset.originalText = elements.generatorButton.innerHTML;
      elements.generatorButton.innerHTML = `
        <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.5-3.5L12 .5v4a8 8 0 00-8 8h4z"></path>
        </svg>
        <span>Queueing…</span>
      `;
    }
    try {
      const formData = new FormData(elements.generatorForm);
      const response = await fetch(elements.generatorForm.action || "/analytical_reports/jobs", {
        method: "POST",
        body: formData,
      });
      const body = await response.json().catch(() => ({}));
      if (!response.ok) {
        showBanner(elements.generatorFeedback, body.error || "Failed to start the job.", "error");
        return;
      }
      state.jobId = body.job_id;
      state.meta = body.meta || {};
      clearLog(false);
      if (Array.isArray(body.events)) {
        body.events.forEach((evt) => appendLog(evt));
      }
      setStatus(body.status || "queued", state.meta);
      updateTeam(state.meta);
      if (elements.messageInput) {
        elements.messageInput.focus({ preventScroll: true });
      }
      attachEventSource(state.jobId);
      showBanner(elements.generatorFeedback, "Job queued. The worker will pick it up shortly.", "info");
    } catch (error) {
      console.error("Failed to start analytical job", error);
      showBanner(elements.generatorFeedback, "Unexpected error while queueing the job.", "error");
    } finally {
      if (elements.generatorButton) {
        elements.generatorButton.disabled = false;
        if (elements.generatorButton.dataset.originalText) {
          elements.generatorButton.innerHTML = elements.generatorButton.dataset.originalText;
        }
      }
    }
  };

  const handleTerminalSubmit = (event) => {
    event.preventDefault();
    if (!elements.messageInput) return;
    const value = elements.messageInput.value.trim();
    if (!value) {
      elements.messageInput.focus();
      return;
    }
    sendUserMessage({ message: value });
    elements.messageInput.value = "";
  };

  const handleCancelClick = async () => {
    if (!state.jobId || !elements.cancelButton) return;
    const label = elements.cancelLabel;
    const fallbackLabel = label && label.dataset ? label.dataset.defaultLabel || "Cancel" : "Cancel";
    const originalLabel = label ? label.textContent || fallbackLabel : fallbackLabel;
    elements.cancelButton.disabled = true;
    if (label) {
      label.textContent = "Cancelling…";
    }
    try {
      const response = await fetch(`/analytical_reports/jobs/${state.jobId}/cancel`, {
        method: "POST",
      });
      const body = await response.json().catch(() => ({}));
      if (!response.ok) {
        showBanner(elements.terminalAlert, body.error || "Failed to cancel the job.", "error");
        if (label) {
          label.textContent = originalLabel || fallbackLabel;
        }
        elements.cancelButton.disabled = false;
        return;
      }
      showBanner(elements.terminalAlert, body.message || "Cancellation requested.", "warning");
      setStatus(body.status || "cancelling", state.meta);
      refreshTerminalControls();
      // Close live stream immediately
      if (state.eventSource) {
        try { state.eventSource.close(); } catch (e) {}
        state.eventSource = null;
      }
      // Put terminal into default idle state and keep it visible
      state.jobId = null;
      setStatus("idle", {});
      if (elements.spinner) elements.spinner.classList.add("hidden");
      if (elements.cancelButton) elements.cancelButton.classList.add("hidden");
      if (elements.terminalRoot) elements.terminalRoot.classList.remove("hidden");
      updateTeam({});
      // Reload the page now that the queue is cleared to present a clean state
      window.location.reload();
    } catch (error) {
      console.error("Failed to cancel analytical job", error);
      showBanner(elements.terminalAlert, "Unexpected error while cancelling the job.", "error");
      if (label) {
        label.textContent = originalLabel || fallbackLabel;
      }
      elements.cancelButton.disabled = false;
    }
  };

  const handleSaveClick = async () => {
    if (!elements.latestSave || !elements.latestSave.dataset.payload) return;
    try {
      const payload = JSON.parse(elements.latestSave.dataset.payload);
      const response = await fetch("/analytical_reports/library", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const body = await response.json().catch(() => ({}));
      if (!response.ok) {
        showBanner(elements.terminalAlert, body.error || "Could not save the report.", "error");
        return;
      }
      showBanner(elements.terminalAlert, body.message || "Report saved to quick access.", body.status === "saved" ? "info" : "warning");
      // Reload the page to reflect the saved report consistently
      window.location.reload();
    } catch (error) {
      console.error("Failed to save report entry", error);
      showBanner(elements.terminalAlert, "Unexpected error while saving to the library.", "error");
    }
  };

  const handleCopyClick = async () => {
    if (!elements.latestCopy || !elements.latestCopy.dataset.url) return;
    try {
      await navigator.clipboard.writeText(elements.latestCopy.dataset.url);
      showBanner(elements.terminalAlert, "Report link copied to clipboard.", "info");
    } catch (error) {
      showBanner(elements.terminalAlert, "Clipboard copy failed. Copy the link manually.", "warning");
    }
  };

  const handleDeleteClick = async (event) => {
    const button = event.currentTarget;
    const spreadsheetUrl = button.dataset.spreadsheetUrl;
    if (!spreadsheetUrl) {
      return;
    }
    const teamName = button.dataset.teamName || "this report";
    const confirmed = window.confirm(`Delete the saved report for ${teamName}? This cannot be undone.`);
    if (!confirmed) {
      return;
    }

    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = "Deleting…";

    try {
      const response = await fetch("/analytical_reports/library", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ report_spreadsheet_url: spreadsheetUrl }),
      });
      const body = await response.json().catch(() => ({}));
      if (!response.ok) {
        showBanner(elements.terminalAlert, body.error || "Could not delete the report.", "error");
        button.disabled = false;
        button.textContent = originalText;
        return;
      }
      showBanner(
        elements.terminalAlert,
        body.message || "Report removed from the quick access list.",
        body.status === "deleted" ? "info" : "warning"
      );
      const listItem = button.closest("[data-report-item]");
      if (listItem) {
        listItem.remove();
      }
    } catch (error) {
      console.error("Failed to delete report entry", error);
      showBanner(elements.terminalAlert, "Unexpected error while deleting the report.", "error");
      button.disabled = false;
      button.textContent = originalText;
    }
  };

  if (elements.generatorForm) {
    elements.generatorForm.addEventListener("submit", handleGeneratorSubmit);
  }
  if (elements.terminalForm) {
    elements.terminalForm.addEventListener("submit", handleTerminalSubmit);
  }
  if (elements.clearButton) {
    elements.clearButton.addEventListener("click", () => clearLog());
  }
  if (elements.latestSave) {
    elements.latestSave.addEventListener("click", handleSaveClick);
  }
  if (elements.latestCopy) {
    elements.latestCopy.addEventListener("click", handleCopyClick);
  }
  document.querySelectorAll("[data-delete-report]").forEach((button) => {
    button.addEventListener("click", handleDeleteClick);
  });
  if (elements.cancelButton) {
    elements.cancelButton.addEventListener("click", handleCancelClick);
  }

  if (typeof window.initReportPreviews === "function") {
    window.initReportPreviews();
  }
  if (typeof window.renderVisibleReports === "function") {
    window.renderVisibleReports();
  }

  hydrateFromBootstrap();

  // Aggressively hide spinner on initial load if no active job
  if (elements.spinner && !isJobActive()) {
    elements.spinner.classList.add("hidden");
    elements.spinner.style.display = "none";
  }

  if (!redisAvailable) {
    showBanner(
      elements.terminalAlert,
      "Redis is offline. Start Redis and the RQ worker to enable live streaming.",
      "warning"
    );
  }

  window.addEventListener("beforeunload", () => {
    if (state.eventSource) {
      state.eventSource.close();
    }
  });
});
</script>
{% endblock %}
