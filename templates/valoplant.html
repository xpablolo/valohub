{% extends "base.html" %}

{% block title %}Valoplant{% endblock %}

{% block content %}
<style>
    /* ========== EXISTING STYLES (LIGHT MODE) ========== */

    header {
        background-color: #222;
        color: #fff;
        padding: 1rem;
        text-align: center;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    label {
        display: block;
        font-weight: bold;
    }
    input, select {
        width: 100%;
        padding: 0.8rem;
        margin-top: 0.5rem;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    button {
        padding: 1rem;
        background-color: #5c6bc0;
        color: #fff;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 1rem;
        margin-top: 1rem;
        margin-right: 0.5rem;
    }
    button:hover {
        background-color: #3f4ccf;
    }
    .strategy-list {
        margin-top: 2rem;
    }
    .map-strategy {
        margin-bottom: 1rem;
    }
    .map-title {
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        margin: 0.5rem 0;
        color: #fff; /* already white text over #222 header */
    }
    .map-title:hover {
        color: #5c6bc0;
    }
    .compositions {
        display: none;
        margin-left: 1rem;
    }
    .composition-title {
        font-size: 1rem;
        margin: -0.7rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .strategy-item a {
        color: #5c6bc0;
        text-decoration: none;
    }
    .remove-btn, .show-btn {
        padding: 0.4rem 0.8rem;
        border: none;
        cursor: pointer;
        border-radius: 3px;
        font-size: 1rem;
    }
    .remove-btn {
        background-color: #e57373;
        color: #fff;
    }
    .remove-btn:hover {
        background-color: #d32f2f;
    }
    .show-btn {
        background-color: #4caf50;
        color: #fff;
    }
    .show-btn:hover {
        background-color: #388e3c;
    }
    .strategy-view {
        display: none;
        margin-top: 1rem;
        border: 1px solid #ddd;
        padding: 0.5rem;
        background-color: #fff;
        width: 130%;
        margin-left: -15%;
        height: 800px; /* Must specify 'px' or other unit */
    }
    .iframe {
        width: 100%;
        height: 800px;
    }

    /* ========== DARK MODE OVERRIDES ========== */
    /* 
       When <body> has class="dark-mode", these rules apply.
       Adjust color codes as needed to keep design consistent, just darker.
    */
    .dark-mode header {
        background-color: #111 !important;
        color: #fff !important;
    }
    .dark-mode .map-title {
        color: #fff !important; /* Keep it visible over dark backgrounds */
    }
    .dark-mode .container {
        background-color: #1e1e1e !important;
        border-radius: 6px;
        border: 1px solid #333;
    }
    .dark-mode label {
        color: #fff !important;
    }
    .dark-mode input, 
    .dark-mode select {
        background-color: #2c2c2c !important;
        color: #fff !important;
        border: 1px solid #555 !important;
    }
    .dark-mode button {
        background-color: #5c6bc0 !important;
        color: #fff !important;
    }
    .dark-mode button:hover {
        background-color: #3f4ccf !important;
    }
    .dark-mode .remove-btn {
        background-color: #e57373 !important;
    }
    .dark-mode .remove-btn:hover {
        background-color: #d32f2f !important;
    }
    .dark-mode .show-btn {
        background-color: #4caf50 !important;
    }
    .dark-mode .show-btn:hover {
        background-color: #388e3c !important;
    }
    .dark-mode .strategy-view {
        background-color: #2c2c2c !important;
        border-color: #444 !important;
    }
</style>

<div class="container">
    <h1 class="text-center mb-4" style="font-weight: bold;">Saved Strats</h1>
    <div id="strategy-list">
        {% for map, compositions in strategies.items() %}
            <div class="map-strategy">
                <div class="map-title" onclick="toggleCompositions('{{ map }}')">
                    {{ map }}
                </div>
                <div class="compositions" id="compositions-{{ map }}">
                    {% for comp, url in compositions.items() %}
                    <div class="composition-title">
                        <span>
                            {{ comp }}: <a href="{{ url }}" target="_blank">{{ url }}</a>
                        </span>
                        <div style="display: flex; gap: 0.5rem; margin-left: auto;">
                            <button class="show-btn" onclick="showStrategy('{{ map }}', '{{ comp }}', '{{ url }}')">Show</button>
                            <button class="remove-btn" onclick="confirmRemove('{{ map }}', '{{ comp }}')">Remove</button>
                        </div>
                    </div>
                    <div id="strategy-view-{{ map }}-{{ comp }}" class="strategy-view">
                        <iframe src="{{ url }}" width="100%" height="800"></iframe>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

    <h1 class="text-center mb-4" style="font-weight: bold;">Add New Strat</h1>
    <div class="form-group">
        <label for="map">Select Map</label>
        <select id="map">
            <option value="Abyss">Abyss</option>
            <option value="Bind">Bind</option>
            <option value="Fracture">Fracture</option>
            <option value="Haven">Haven</option>
            <option value="Lotus">Lotus</option>
            <option value="Pearl">Pearl</option>
            <option value="Split">Split</option>
        </select>
    </div>

    <div class="form-group">
        <label for="comp">Enter Strat Name</label>
        <input type="text" id="comp" placeholder="Enter strategy name">
    </div>
    <div class="form-group">
        <label for="url">Valoplant Strategy URL</label>
        <input type="url" id="url" placeholder="Enter Valoplant Strategy URL">
    </div>
    <button onclick="saveStrategy()">Save Strategy</button>
</div>

<script>
    function toggleCompositions(map) {
        const compositionsDiv = document.getElementById(`compositions-${map}`);
        compositionsDiv.style.display =
            compositionsDiv.style.display === 'none' || !compositionsDiv.style.display
                ? 'block'
                : 'none';
    }

    function showStrategy(map, comp, url) {
        const strategyView = document.getElementById(`strategy-view-${map}-${comp}`);
        strategyView.style.display =
            strategyView.style.display === 'none' || !strategyView.style.display
                ? 'block'
                : 'none';
    }

    document.getElementById('map').addEventListener('change', updateCompositions);

    function updateCompositions() {
        const map = document.getElementById('map').value;

        fetch(`/get_compositions?map=${map}`)
            .then(response => response.json())
            .then(data => {
                const compDropdown = document.getElementById('comp');
                compDropdown.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = 'Standard';
                defaultOption.textContent = 'Standard';
                compDropdown.appendChild(defaultOption);

                if (data.compositions && data.compositions.length > 0) {
                    data.compositions.forEach(comp => {
                        const option = document.createElement('option');
                        option.value = comp;
                        option.textContent = comp;
                        compDropdown.appendChild(option);
                    });
                }
            })
            .catch(err => console.error('Error fetching compositions:', err));
    }

    function saveStrategy() {
        const map = document.getElementById('map').value;
        const comp = document.getElementById('comp').value;
        const url = document.getElementById('url').value;

        if (!comp || !url) {
            alert('Please enter a strategy name and a valid URL!');
            return;
        }

        fetch('/save_strategy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ map, comp, url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Strategy saved successfully!');
                location.reload();
            } else {
                alert('Failed to save strategy.');
            }
        })
        .catch(err => console.error('Error:', err));
    }

    function confirmRemove(map, comp) {
        const firstConfirm = confirm(
            `Are you sure you want to remove the strategy for "${map}" with composition "${comp}"?`
        );
        if (firstConfirm) {
            const secondConfirm = confirm(
                'This action is irreversible. Do you want to proceed?'
            );
            if (secondConfirm) {
                removeStrategy(map, comp);
            }
        }
    }

    function removeStrategy(map, comp) {
        fetch('/remove_strategy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ map, comp })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Strategy removed successfully!');
                location.reload();
            } else {
                alert('Failed to remove strategy.');
            }
        })
        .catch(err => console.error('Error:', err));
    }
</script>

{% endblock %}
