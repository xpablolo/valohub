{% extends "base.html" %}

{% block title %}Search{% endblock %}

{% block content %}
<style>
  .surface-card { box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.10); }
  .ring-muted   { box-shadow: 0 0 0 1px rgba(16,24,40,.08) inset; }
  .dark-mode .agents-page .surface-card { background-color: #111827 !important; color: #e5e7eb !important; }
  .dark-mode .agents-page .ring-muted   { box-shadow: 0 0 0 1px rgba(255,255,255,.12) inset; }
  .dark-mode .agents-page .text-gray-900 { color: #e5e7eb !important; }
  .dark-mode .agents-page .text-gray-700 { color: #cbd5e1 !important; }
  .dark-mode .agents-page .bg-white { background-color: #111827 !important; }
  .dark-mode .agents-page .border-gray-200 { border-color: #374151 !important; }
  /* Dark mode: Alerts (loading, errors) match site palette */
  .dark-mode .agents-page .alert {
    background-color: #111827 !important;
    color: #e5e7eb !important;
    border: 1px solid #374151 !important;
    border-left-width: 4px !important;
  }
  .dark-mode .agents-page .alert-info    { border-left-color: #60a5fa !important; }
  .dark-mode .agents-page .alert-warning { border-left-color: #f59e0b !important; }
  .dark-mode .agents-page .alert-danger  { border-left-color: #f43f5e !important; }

  /* Dark mode: search input styling consistent with other pages */
  .dark-mode .agents-page input[type="text"],
  .dark-mode .agents-page select,
  .dark-mode .agents-page textarea {
    background-color: #111827 !important;
    color: #e5e7eb !important;
    border-color: #374151 !important;
    box-shadow: none !important;
  }
  .dark-mode .agents-page input[type="text"]:focus,
  .dark-mode .agents-page select:focus,
  .dark-mode .agents-page textarea:focus {
    outline: none !important;
    border-color: #60a5fa !important;
    box-shadow: 0 0 0 1px #60a5fa inset !important;
  }
  .dark-mode .agents-page input[type="text"]::placeholder { color: #9ca3af !important; }
</style>

<div class="agents-page mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Agents</h1>
      <p class="text-sm text-gray-500">Search opponents and view ranked data</p>
    </div>
  </div>
<style>
  /* Sticky header cells for Tailwind tables */
  .sticky-th { position: sticky; top: 0; background: #fff; z-index: 10; }

  /* Tailwind-like dark mode table styling (match other pages) */
  .dark-mode .agents-page .sticky-th { background: #111827 !important; color: #9ca3af !important; border-color: #374151 !important; }
  .dark-mode .agents-page table th,
  .dark-mode .agents-page table td { color: #e5e7eb !important; border-color: #374151 !important; }
  .dark-mode .agents-page tr:hover { background-color: #1f2937 !important; }
  .dark-mode .agents-page .text-gray-900 { color: #e5e7eb !important; }
  .dark-mode .agents-page .text-gray-700 { color: #cbd5e1 !important; }
  .dark-mode .agents-page .bg-white { background-color: #111827 !important; }
  .dark-mode .agents-page .border-gray-200 { border-color: #374151 !important; }

  /* ALERTS + LIST GROUP (for search results) in dark mode */
  .dark-mode .alert {
    background-color: #2e2e2e !important;
    color: #ffffff !important;
    border-color: #444444 !important;
  }
  .dark-mode .list-group-item {
    background-color: #1e1e1e !important;
    color: #ffffff !important;
    border-color: #333333 !important;
  }
  .dark-mode .list-group-item:hover {
    background-color: #2a2a2a !important;
  }
  /* DARK MODE: filter panel */
  .dark-mode .bg-light {
    background-color: #2c2c2c !important;
  }
  .dark-mode .border {
    border-color: #444444 !important;
  }
  .dark-mode .btn-outline-primary {
    color: #ffffff !important;
    border-color: #555555 !important;
  }
  .dark-mode .btn-outline-primary:hover {
    background-color: #555555 !important;
  }
  .dark-mode .btn-primary {
    background-color: #444444 !important;
    border-color: #555555 !important;
    color: #ffffff !important;
  }
  .dark-mode .form-control {
    background-color: #1e1e1e !important;
    color: #ffffff !important;
    border-color: #444444 !important;
  }
  .dark-mode .form-label {
    color: #cccccc !important;
  }
  .dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
  }
  /* hide spinner by default */
  .d-none { display: none !important; }
</style>

<!-- Background image -->
<div class="surface-card bg-white rounded-xl p-4 ring-muted mb-4">
  <h3 class="text-base font-semibold text-gray-900 mb-2">Search for Opponents</h3>
  <form id="searchForm">
    <input type="text" id="searchPlayer" class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm" placeholder="Enter Player Name to Search" />
  </form>
  <div id="searchResults" class="mt-3"></div>
</div>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
/>
<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>


<script>
// Fetch detailed data after selecting a player
    document.getElementById("searchPlayer").addEventListener("input", function(event) {
        var searchQuery = event.target.value;

        // Clear if empty
        if (!searchQuery) {
            document.getElementById("searchResults").innerHTML = "";
            return;
        }

        fetch("/search_player_autocomplete", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "query=" + encodeURIComponent(searchQuery)
        })
        .then(response => response.json())
        .then(data => {
            var searchResultsDiv = document.getElementById("searchResults");
            searchResultsDiv.innerHTML = ""; // Clear previous results

            if (data.success) {
                if (data.players.length > 0) {
                    var playerListHTML = '<ul class="list-group">';
                    data.players.forEach(player => {
                        playerListHTML += `<li class="list-group-item">${player}</li>`;
                    });
                    playerListHTML += "</ul>";
                    searchResultsDiv.innerHTML = playerListHTML;
                } else {
                    searchResultsDiv.innerHTML = '<div class="alert alert-warning">No players found matching the query.</div>';
                }
            } else {
                searchResultsDiv.innerHTML = '<div class="alert alert-danger">Error occurred while fetching player data.</div>';
            }
        })
        .catch(error => {
            console.error("Error fetching player data:", error);
            document.getElementById("searchResults").innerHTML = '<div class="alert alert-danger">Error occurred while fetching player data.</div>';
        });
    });

    // Handle player selection from the list
    document.getElementById("searchResults").addEventListener("click", function(event) {
        if (event.target && event.target.tagName === "LI") {
            var selectedPlayer = event.target.innerText;
            document.getElementById("searchPlayer").value = selectedPlayer;

            // Show a loading message
            document.getElementById("searchResults").innerHTML = '<div class="alert alert-info">Loading data...</div>';

            fetchPlayerData(selectedPlayer);
        }
    });

    // Fetch detailed data after selecting a player
    function fetchPlayerData(playerName) {
        fetch("/search_player", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "player_name=" + encodeURIComponent(playerName)
        })
        .then(response => response.json())
        .then(data => {
            var searchResultsDiv = document.getElementById("searchResults");
            searchResultsDiv.innerHTML = ""; // Clear

            if (data.success) {
              let rowsHtml = '';
              for (const [map, playerData] of Object.entries(data.ranked_data)) {
                const sortedAgents = Object.entries(playerData).sort((a, b) => b[1] - a[1]);
                const totalMatches = sortedAgents.reduce((sum, [, cnt]) => sum + cnt, 0);
                const agentsStr = sortedAgents.map(([agent, cnt]) => `${agent}: ${cnt}`).join(', ');
                rowsHtml += `
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-gray-900">${map}</td>
                    <td class="px-4 py-3 text-gray-700">${totalMatches}</td>
                    <td class="px-4 py-3 text-gray-700">${agentsStr}</td>
                  </tr>
                `;
              }

              const rankedInfoHTML = `
                <div class="surface-card bg-white rounded-xl ring-muted overflow-hidden">
                  <div class="px-4 py-3 border-b border-gray-200">
                    <h4 class="text-base font-semibold text-gray-900">Ranked Data for ${playerName} (since ${data.last_day})</h4>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="min-w-full border-separate border-spacing-0">
                      <thead>
                        <tr class="text-left text-xs font-semibold uppercase tracking-wider text-gray-500">
                          <th class="sticky-th px-4 py-3 border-b border-gray-200">Map</th>
                          <th class="sticky-th px-4 py-3 border-b border-gray-200">Matches Played</th>
                          <th class="sticky-th px-4 py-3 border-b border-gray-200">Agents Played</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-100 text-sm">
                        ${rowsHtml}
                      </tbody>
                    </table>
                  </div>
                </div>`;

              searchResultsDiv.innerHTML = rankedInfoHTML;
            } else {
                searchResultsDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error("Error fetching player data:", error);
            document.getElementById("searchResults").innerHTML = `
              <div class="alert alert-danger">
                Error occurred while fetching player data.
              </div>`;
        });
    }
</script>
 
</div>
{% endblock %}
