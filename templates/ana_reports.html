{% extends "base.html" %}

{% block title %}Analytical Reports{% endblock %}

{% block content %}
<style>
  .surface-card { box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.10); }
  .ring-muted   { box-shadow: 0 0 0 1px rgba(16,24,40,.08) inset; }
  .dark-mode .analytical-page .surface-card { background-color: #111827 !important; color: #e5e7eb !important; }
  .dark-mode .analytical-page .ring-muted   { box-shadow: 0 0 0 1px rgba(255,255,255,.12) inset; }
  .dark-mode .analytical-page .text-gray-900 { color: #e5e7eb !important; }
  .dark-mode .analytical-page .text-gray-700 { color: #cbd5e1 !important; }
  .dark-mode .analytical-page .text-gray-500 { color: #9ca3af !important; }
  .dark-mode .analytical-page .bg-white { background-color: #111827 !important; }
  .dark-mode .analytical-page .border-gray-200 { border-color: #374151 !important; }
  .analytical-page .iframe-container { position: relative; width: 100%; height: 56vh; overflow: hidden; padding: 10px; border-radius: 10px; }
  .analytical-page .iframe-container iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.2); }
  @media (min-width: 1200px) { .analytical-page .iframe-container { height: 64vh; } }
  @media (max-width: 768px)  { .analytical-page .iframe-container { height: 64vh; } }
</style>

<div class="analytical-page mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Analytical Reports</h1>
      <p class="text-sm text-gray-500">Google Sheets reports with overall and map-focused statistics by team.</p>
      <p class="mt-1 text-sm text-yellow-600">Note: Some map and comp winrates are not correct right now.</p>
    </div>
    <span class="inline-flex items-center rounded-lg bg-gray-900 px-3 py-1.5 text-base font-semibold text-white shadow-sm">Analytics</span>
  </div>

  <div class="relative mb-10 overflow-hidden rounded-2xl surface-card ring-muted">
    <div class="pointer-events-none absolute inset-0 bg-gradient-to-br from-indigo-500/15 via-sky-500/10 to-emerald-500/15"></div>
    <div class="relative grid gap-8 px-6 py-8 lg:grid-cols-2 lg:px-10">
      <div class="space-y-4">
        <span class="inline-flex items-center rounded-full bg-indigo-500/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-600">Generator</span>
        <h2 class="text-2xl font-semibold text-gray-900">Create a fresh analytical report</h2>
        <p class="text-sm leading-relaxed text-gray-600">
          Start with the essentials here. Once you launch the run, the terminal will guide you through any extra inputs
          while showing live progress as each phase of the report completes.
        </p>
        <ul class="space-y-2 text-sm text-gray-600">
          <li class="flex items-start gap-2">
            <span class="mt-1 inline-flex h-2.5 w-2.5 flex-shrink-0 rounded-full bg-indigo-500"></span>
            <span>Generates overall summary, map-specific tabs, agent comps, planting stats, and positioning heatmaps.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-1 inline-flex h-2.5 w-2.5 flex-shrink-0 rounded-full bg-emerald-500"></span>
            <span>Uploads images through the configured Google service account and delivers the sheet link instantly.</span>
          </li>
        </ul>
        {% if report %}
        <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-3 text-sm text-emerald-800">
          Latest run: <strong>{{ report.team_name }}</strong> ({{ report.match_count }} matches).
          <a class="ml-1 font-medium underline" href="{{ report.spreadsheet_url }}" target="_blank" rel="noopener">Open report</a>
        </div>
        {% endif %}
        {% if error %}
        <div class="rounded-lg border border-red-200 bg-red-50 px-3 py-3 text-sm text-red-700">
          {{ error }}
        </div>
        {% endif %}
        <div class="rounded-xl border border-gray-900/20 bg-gray-900 text-gray-100 shadow-lg">
          <div class="flex items-center justify-between border-b border-white/10 px-3 py-2 text-xs uppercase tracking-wide">
            <span class="font-semibold">Terminal • Analytical Generator</span>
            <span class="text-gray-400">{{ progress_messages|length }} lines</span>
          </div>
          <div class="terminal-log max-h-48 overflow-y-auto px-3 py-3 text-sm leading-relaxed font-mono">
            {% if progress_messages %}
              {% for message in progress_messages %}
              <div class="whitespace-pre-wrap">
                <span class="text-emerald-400">[{{ "%02d" % loop.index }}]</span>
                <span class="ml-2">{{ message }}</span>
              </div>
              {% endfor %}
            {% else %}
            <div class="text-gray-500">Awaiting generation. Press “Initiate generation” to begin.</div>
            {% endif %}
          </div>
          <form method="post" class="flex items-center gap-2 border-t border-white/10 bg-gray-800/70 px-3 py-2 text-sm">
            <input type="hidden" name="action" value="terminal_input" />
            <input type="hidden" name="team" value="{{ selected_team_input }}" />
            <input type="hidden" name="match_count" value="{{ match_count_value }}" />
            <input type="hidden" name="share_email" value="{{ share_email_value }}" />
            <input
              type="text"
              name="terminal_message"
              class="flex-1 rounded-md border border-gray-700 bg-gray-900 px-2 py-1 font-mono text-gray-100 placeholder-gray-500 focus:border-emerald-400 focus:outline-none focus:ring-1 focus:ring-emerald-400"
              placeholder="Type additional instructions or notes and press Enter…"
              autocomplete="off"
            />
            <button type="submit" class="inline-flex items-center rounded-md border border-emerald-400 px-3 py-1 font-semibold text-emerald-400 hover:bg-emerald-500/10">
              Send
            </button>
          </form>
        </div>
        {% if report and report.spreadsheet_url %}
        <div class="rounded-lg border border-gray-200 bg-white/80 px-4 py-4 text-sm shadow-sm">
          <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
              <p class="font-medium text-gray-900">Add this report to the quick access list?</p>
              <p class="text-xs text-gray-500">It will appear with the saved sheets below so you can open it again faster.</p>
            </div>
            <form method="post" class="flex items-center gap-2">
              <input type="hidden" name="action" value="save" />
              <input type="hidden" name="report_team_name" value="{{ report.team_name }}" />
              <input type="hidden" name="report_team_tag" value="{{ report.team_tag }}" />
              <input type="hidden" name="report_spreadsheet_url" value="{{ report.spreadsheet_url }}" />
              <input type="hidden" name="report_match_count" value="{{ report.match_count }}" />
              <input type="hidden" name="report_created_at" value="{{ report_created_at_iso or '' }}" />
              <button type="submit" class="th-btn th-btn-secondary whitespace-nowrap">Save to list</button>
            </form>
          </div>
        </div>
        {% endif %}
      </div>
      <div>
        <form method="post" class="rounded-xl border border-gray-100 bg-white/70 p-6 shadow-sm backdrop-blur">
          <div class="space-y-5">
            <label class="block">
              <span class="text-xs font-semibold uppercase text-gray-500">Team</span>
              <input
                type="text"
                name="team"
                list="team-options"
                placeholder="Start typing a team tag or name"
                value="{{ selected_team_input }}"
                required
                class="mt-1 block w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-inner focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
              />
              <datalist id="team-options">
                {% for team in teams %}
                <option value="{{ team.tag }}" label="{{ team.name }} ({{ team.tag }})"></option>
                <option value="{{ team.name }} ({{ team.tag }})"></option>
                {% endfor %}
              </datalist>
              <p class="mt-1 text-xs text-gray-400">Autocomplete suggestions show as you type; press Enter to accept.</p>
            </label>
            <label class="block">
              <span class="text-xs font-semibold uppercase text-gray-500">Matches / Events to include</span>
              <div class="mt-1 flex items-center gap-2">
                <input
                  type="number"
                  name="match_count"
                  min="1"
                  placeholder="All recent"
                  value="{{ match_count_value }}"
                  class="block w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-inner focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                />
                <span class="text-xs text-gray-400">optional</span>
              </div>
            </label>
            <label class="block">
              <span class="text-xs font-semibold uppercase text-gray-500">Share report with</span>
              <input
                type="email"
                name="share_email"
                placeholder="you@example.com"
                value="{{ share_email_value }}"
                class="mt-1 block w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-inner focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
              />
              <p class="mt-1 text-xs text-gray-400">Leave blank to fall back to the default configured address.</p>
            </label>
            <button
              type="submit"
              class="th-btn th-btn-primary inline-flex w-full items-center justify-center gap-2 py-2.5 text-sm font-semibold"
              id="initiate-generation-button"
            >
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
              <span>Initiate generation</span>
            </button>
            <p class="text-xs text-gray-500">
              Processing can take up to a minute while match details, stats, and visual plots are created.
              Keep the tab open; the terminal above updates as each phase completes.
            </p>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="space-y-2">
    <ul class="list-group space-y-2">
      {% for entry in all_reports %}
      {% set row_id = 'report-' ~ loop.index0 %}
      <li class="list-group-item surface-card bg-white rounded-xl p-3 ring-muted">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
          <div>
            <strong>{{ entry.team_name }}</strong><br />
            <small>Created: {{ entry.created_label }}</small>
            {% if entry.match_count %}
            <span class="ml-2 inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-semibold text-gray-600">
              {{ entry.match_count }} matches
            </span>
            {% endif %}
            {% if entry.source == "saved" %}
            <span class="ml-2 inline-flex items-center rounded-full bg-indigo-100 px-2 py-0.5 text-xs font-semibold text-indigo-600">
              Saved
            </span>
            {% endif %}
          </div>
          <button class="th-btn th-btn-primary" data-toggle-target="{{ row_id }}">Show Sheet</button>
        </div>
        <div class="iframe-container hidden mt-2" id="sheet-container-{{ row_id }}">
          <iframe
            id="google-sheet-{{ row_id }}"
            data-sheet-iframe="true"
            src="{{ entry.spreadsheet_url }}"
            frameborder="0"
          ></iframe>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>

<style>
  .iframe-container {
    position: relative;
    height: 56vh;
    width: 100%;
    overflow: hidden;
    padding: 10px;
    border-radius: 6px;
  }

  iframe {
    position: absolute;
    top: 0; 
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transform: scale(1);
    transform-origin: 0 0;
  }

  @media (min-width: 1200px) {
    .iframe-container { height: 64vh; }
  }

  @media (max-width: 768px) {
    .iframe-container { height: 64vh; }
  }
</style>

<script>
  window.addEventListener("load", function () {
    setTimeout(function () {
      document.querySelectorAll("[data-sheet-iframe]").forEach(function (iframe) {
        iframe.style.height = "100%";
      });
    }, 200);
  });

  document.querySelectorAll("[data-toggle-target]").forEach(function (button) {
    button.addEventListener("click", function () {
      const targetId = button.getAttribute("data-toggle-target");
      const container = document.getElementById("sheet-container-" + targetId);
      if (!container) return;
      const isHidden = container.classList.contains("hidden");
      container.classList.toggle("hidden", !isHidden);
      button.innerText = isHidden ? "Hide Sheet" : "Show Sheet";
    });
  });

  const generatorButton = document.getElementById("initiate-generation-button");
  if (generatorButton) {
    generatorButton.addEventListener("click", function () {
      generatorButton.classList.add("opacity-75", "pointer-events-none");
      generatorButton.innerHTML = `
        <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.5-3.5L12 .5v4a8 8 0 00-8 8h4z"></path>
        </svg>
        <span>Initiating…</span>
      `;
    });
  }
</script>
{% endblock %}
